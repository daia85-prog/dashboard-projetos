<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Dashboard Projetos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 25px 30px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header h1 { color: #1a1a2e; font-size: 24px; }
        .header p { color: #64748b; font-size: 13px; }
        .btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.4); }
        .btn-secondary { background: linear-gradient(135deg, #64748b, #475569); }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .card { background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); margin-bottom: 25px; overflow: hidden; }
        .card-header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px 25px; }
        .card-header h2 { font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .card-body { padding: 25px; }
        textarea { width: 100%; height: 200px; border: 2px solid #e5e7eb; border-radius: 10px; padding: 15px; font-family: 'Consolas', monospace; font-size: 12px; resize: vertical; }
        textarea:focus { outline: none; border-color: #667eea; }
        .action-buttons { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .message { padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        .message.success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .message.error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .hidden { display: none; }
        .validation-section { margin-top: 20px; padding: 20px; background: #f8fafc; border-radius: 10px; }
        .validation-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .validation-status { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .validation-status.success { background: #d1fae5; color: #065f46; }
        .validation-status.warning { background: #fef3c7; color: #92400e; }
        .validation-status.error { background: #fee2e2; color: #991b1b; }
        .validation-item { padding: 10px 15px; margin: 5px 0; border-radius: 8px; font-size: 13px; display: flex; align-items: center; gap: 10px; }
        .validation-item.ok { background: #ecfdf5; color: #065f46; }
        .validation-item.warning { background: #fffbeb; color: #92400e; }
        .validation-item.error { background: #fef2f2; color: #991b1b; }
        .preview-section { margin-top: 20px; }
        .preview-section h3 { margin-bottom: 15px; color: #1a1a2e; font-size: 16px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: #667eea; color: white; padding: 12px; text-align: left; }
        td { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; }
        tr:hover { background: #f8fafc; }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge-status { background: #dbeafe; color: #1e40af; }
        .badge-rag-verde { background: #d1fae5; color: #065f46; }
        .badge-rag-amarelo { background: #fef3c7; color: #92400e; }
        .badge-rag-vermelho { background: #fee2e2; color: #991b1b; }
        .badge-rag-cinza { background: #f3f4f6; color: #374151; }
        .help-text { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .help-text h4 { color: #1e40af; margin-bottom: 10px; }
        .help-text ol { margin-left: 20px; color: #1e40af; }
        .help-text li { margin: 8px 0; font-size: 13px; }
        @media (max-width: 768px) { .header { flex-direction: column; } .action-buttons { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div><h1>üîß √Årea Administrativa</h1><p>Gerenciamento do Dashboard</p></div>
            <a href="index.html" class="btn btn-secondary">‚Üê Voltar</a>
        </div>
        <div id="successMsg" class="message success hidden"><span>‚úÖ</span><div><strong>Sucesso!</strong> <span id="successText"></span></div></div>
        <div id="errorMsg" class="message error hidden"><span>‚ùå</span><div><strong>Erro!</strong> <span id="errorText"></span></div></div>
        <div class="card">
            <div class="card-header"><h2>üìã Importar Dados da Planilha</h2></div>
            <div class="card-body">
                <div class="help-text">
                    <h4>üìù Como atualizar o dashboard:</h4>
                    <ol>
                        <li>Abra a planilha <strong>Template_Projetos_Infra.xlsx</strong></li>
                        <li>Selecione todos os dados da aba "Projetos" (Ctrl+A)</li>
                        <li>Copie (Ctrl+C)</li>
                        <li>Cole na √°rea abaixo (Ctrl+V)</li>
                        <li>Clique em <strong>"Carregar e Validar"</strong></li>
                        <li>Se estiver OK, clique em <strong>"Exportar dados.json"</strong></li>
                        <li>Fa√ßa upload do arquivo no GitHub</li>
                    </ol>
                </div>
                <textarea id="dataInput" placeholder="Cole aqui os dados copiados da planilha Excel..."></textarea>
                <div class="action-buttons">
                    <button class="btn" onclick="processData()">üì• Carregar e Validar</button>
                    <button class="btn btn-secondary" onclick="clearData()">üóëÔ∏è Limpar</button>
                </div>
                <div id="validationSection" class="validation-section hidden">
                    <div class="validation-header">
                        <h3>üìã Valida√ß√£o</h3>
                        <span class="validation-status" id="validationStatus">Verificando...</span>
                    </div>
                    <div id="validationItems"></div>
                </div>
                <div id="previewSection" class="preview-section hidden">
                    <h3>üëÄ Preview (<span id="previewCount">0</span>)</h3>
                    <div style="overflow-x: auto;">
                        <table><thead><tr><th>Projeto</th><th>Status</th><th>RAG</th><th>%</th><th>Etapa</th><th>Go Live</th><th>Respons√°vel</th></tr></thead><tbody id="previewTable"></tbody></table>
                    </div>
                </div>
            </div>
        </div>
        <div id="exportCard" class="card hidden">
            <div class="card-header" style="background: linear-gradient(135deg, #10b981, #059669);"><h2>üì§ Exportar Dados</h2></div>
            <div class="card-body">
                <p style="margin-bottom: 20px; color: #64748b;">Clique no bot√£o abaixo para baixar o arquivo <strong>dados.json</strong>. Depois, fa√ßa upload no GitHub.</p>
                <button class="btn btn-success" onclick="exportJSON()">‚¨áÔ∏è Exportar dados.json</button>
            </div>
        </div>
    </div>
    <script>
        let projects = [];
        let validationErrors = [];
        let validationWarnings = [];
        const validStatuses = ['andamento', 'conclu', 'atras', 'aguard', 'n√£o iniciado', 'nao iniciado', 'bloqueado'];
        const validRags = ['verde', 'amarelo', 'vermelho', 'cinza'];

        function showMessage(type, text) {
            const el = document.getElementById(type === 'success' ? 'successMsg' : 'errorMsg');
            document.getElementById(type === 'success' ? 'successText' : 'errorText').textContent = text;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        function clearData() {
            document.getElementById('dataInput').value = '';
            document.getElementById('validationSection').classList.add('hidden');
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('exportCard').classList.add('hidden');
            projects = [];
        }

        function processData() {
            validationErrors = [];
            validationWarnings = [];
            const text = document.getElementById('dataInput').value.trim();
            if (!text) { showMessage('error', 'Cole os dados da planilha primeiro.'); return; }
            try {
                projects = parseData(text);
                if (projects.length === 0) { showMessage('error', 'Nenhum projeto encontrado.'); return; }
                projects.forEach((p, i) => {
                    const statusNorm = (p.status || '').toLowerCase();
                    if (!validStatuses.some(s => statusNorm.includes(s))) validationWarnings.push(`Linha ${i+2}: Status "${p.status}" pode n√£o ser reconhecido`);
                    const ragNorm = (p.rag || '').toLowerCase();
                    if (ragNorm && !validRags.includes(ragNorm)) validationWarnings.push(`Linha ${i+2}: RAG "${p.rag}" inv√°lido`);
                    if (p.progresso < 0 || p.progresso > 100) validationErrors.push(`Linha ${i+2}: Progresso ${p.progresso}% fora do intervalo`);
                    if (!p.projeto || p.projeto.length < 2) validationErrors.push(`Linha ${i+2}: Nome do projeto inv√°lido`);
                });
                showValidationResults();
                showPreview();
                if (validationErrors.length === 0) {
                    document.getElementById('exportCard').classList.remove('hidden');
                    showMessage('success', `${projects.length} projetos carregados!`);
                }
            } catch(e) { showMessage('error', 'Erro: ' + e.message); }
        }

        function parseData(text) {
            text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length < 2) return [];
            const data = [];
            const headers = lines[0].split('\t').map(h => h.trim().toLowerCase());
            const colMap = {
                projeto: headers.findIndex(h => h.includes('projeto')),
                status: headers.findIndex(h => h === 'status'),
                rag: headers.findIndex(h => h.includes('rag')),
                progresso: headers.findIndex(h => h.includes('progresso')),
                etapa: headers.findIndex(h => h.includes('etapa')),
                proximo: headers.findIndex(h => h.includes('proximo') || h.includes('pr√≥ximo')),
                bloqueador: headers.findIndex(h => h.includes('bloqueador')),
                goliveOriginal: headers.findIndex(h => h.includes('golive_original') || h.includes('goliveoriginal') || h.includes('original')),
                goliveAtual: headers.findIndex(h => h.includes('golive_atual') || h.includes('goliveatual')),
                golive: headers.findIndex(h => (h.includes('golive') || h.includes('go_live')) && !h.includes('original') && !h.includes('atual')),
                respInterno: headers.findIndex(h => h.includes('responsavel_interno') || h.includes('interno')),
                respCliente: headers.findIndex(h => h.includes('responsavel_cliente') || h.includes('cliente')),
                localizacao: headers.findIndex(h => h.includes('localizacao') || h.includes('localiza√ß√£o')),
                diasSemAtual: headers.findIndex(h => h.includes('dias')),
                ultAtual: headers.findIndex(h => h.includes('ultima') || h.includes('√∫ltima')),
                obs: headers.findIndex(h => h.includes('obs'))
            };
            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split('\t').map(c => c.trim());
                const projeto = cols[colMap.projeto] || cols[0];
                if (!projeto) continue;
                let goliveOriginal, goliveAtual;
                if (colMap.goliveOriginal >= 0 && colMap.goliveAtual >= 0) {
                    goliveOriginal = formatDate(cols[colMap.goliveOriginal]) || '-';
                    goliveAtual = formatDate(cols[colMap.goliveAtual]) || '-';
                } else if (colMap.golive >= 0) {
                    goliveOriginal = formatDate(cols[colMap.golive]) || '-';
                    goliveAtual = formatDate(cols[colMap.golive]) || '-';
                } else {
                    goliveOriginal = formatDate(cols[7]) || '-';
                    goliveAtual = formatDate(cols[8]) || formatDate(cols[7]) || '-';
                }
                const respIdx = colMap.goliveAtual >= 0 ? 9 : 8;
                data.push({
                    projeto: projeto,
                    status: cols[colMap.status] || cols[1] || '',
                    rag: (cols[colMap.rag] || cols[2] || 'cinza').toLowerCase(),
                    progresso: parseInt(cols[colMap.progresso] || cols[3] || '0') || 0,
                    etapa: cols[colMap.etapa] || cols[4] || '-',
                    proximo: cols[colMap.proximo] || cols[5] || '-',
                    bloqueador: cols[colMap.bloqueador] || cols[6] || '-',
                    goliveOriginal: goliveOriginal,
                    goliveAtual: goliveAtual,
                    golive: goliveAtual,
                    respInterno: cols[colMap.respInterno] || cols[respIdx] || '-',
                    respCliente: cols[colMap.respCliente] || cols[respIdx+1] || '-',
                    localizacao: cols[colMap.localizacao] || cols[respIdx+2] || '-',
                    diasSemAtual: parseInt(cols[colMap.diasSemAtual] || cols[respIdx+3] || '0') || 0,
                    ultAtual: formatDate(cols[colMap.ultAtual] || cols[respIdx+4]) || '-',
                    obs: cols[colMap.obs] || cols[respIdx+5] || '-'
                });
            }
            return data;
        }

        function formatDate(val) {
            if (!val || val === '-' || val === '') return null;
            if (typeof val === 'number') {
                const d = new Date((val - 25569) * 86400 * 1000);
                return d.toLocaleDateString('pt-BR');
            }
            if (val.includes('/')) return val;
            if (val.includes('-')) {
                const parts = val.split('-');
                if (parts[0].length === 4) return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            return val;
        }

        function showValidationResults() {
            const section = document.getElementById('validationSection');
            const items = document.getElementById('validationItems');
            const status = document.getElementById('validationStatus');
            let html = `<div class="validation-item ok">‚úÖ ${projects.length} projetos encontrados</div>`;
            validationWarnings.forEach(w => { html += `<div class="validation-item warning">‚ö†Ô∏è ${w}</div>`; });
            validationErrors.forEach(e => { html += `<div class="validation-item error">‚ùå ${e}</div>`; });
            items.innerHTML = html;
            if (validationErrors.length > 0) { status.textContent = `${validationErrors.length} erro(s)`; status.className = 'validation-status error'; }
            else if (validationWarnings.length > 0) { status.textContent = `${validationWarnings.length} aviso(s)`; status.className = 'validation-status warning'; }
            else { status.textContent = 'Tudo OK!'; status.className = 'validation-status success'; }
            section.classList.remove('hidden');
        }

        function showPreview() {
            document.getElementById('previewCount').textContent = `${projects.length} projetos`;
            const goliveAlterado = (p) => p.goliveOriginal !== p.goliveAtual && p.goliveOriginal !== '-' && p.goliveAtual !== '-';
            document.getElementById('previewTable').innerHTML = projects.slice(0, 10).map(p => `<tr>
                <td><strong>${p.projeto}</strong></td>
                <td><span class="badge badge-status">${p.status}</span></td>
                <td><span class="badge badge-rag-${p.rag}">${p.rag}</span></td>
                <td>${p.progresso}%</td>
                <td>${p.etapa}</td>
                <td>${goliveAlterado(p) ? `<span style="color:#92400e;font-weight:bold;">‚ö†Ô∏è ${p.goliveAtual}</span>` : p.goliveAtual}</td>
                <td>${p.respInterno}</td>
            </tr>`).join('');
            document.getElementById('previewSection').classList.remove('hidden');
        }

        function exportJSON() {
            const data = { lastUpdate: new Date().toISOString(), projects: projects };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dados.json';
            a.click();
            URL.revokeObjectURL(url);
            showMessage('success', 'Arquivo dados.json exportado! Fa√ßa upload no GitHub.');
        }
    </script>
</body>
</html>
