<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Dashboard Projetos v5.3.1</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 25px 30px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header h1 { color: #1a1a2e; font-size: 24px; }
        .version { background: #ede9fe; color: #7c3aed; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-left: 10px; }
        .btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.4); }
        .btn-secondary { background: linear-gradient(135deg, #64748b, #475569); }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); }
        .card { background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); margin-bottom: 25px; overflow: hidden; }
        .card-header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px 25px; }
        .card-header h2 { font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .card-body { padding: 25px; }
        textarea { width: 100%; height: 200px; border: 2px solid #e5e7eb; border-radius: 10px; padding: 15px; font-family: 'Consolas', monospace; font-size: 12px; resize: vertical; }
        textarea:focus { outline: none; border-color: #667eea; }
        .action-buttons { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .message { padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        .message.success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .message.error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .hidden { display: none; }
        .validation-section { margin-top: 20px; padding: 20px; background: #f8fafc; border-radius: 10px; }
        .validation-status { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .validation-status.success { background: #d1fae5; color: #065f46; }
        .validation-item { padding: 10px 15px; margin: 5px 0; border-radius: 8px; font-size: 13px; display: flex; align-items: center; gap: 10px; }
        .validation-item.ok { background: #ecfdf5; color: #065f46; }
        .validation-item.warning { background: #fffbeb; color: #92400e; }
        .preview-section { margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: #667eea; color: white; padding: 12px; text-align: left; }
        td { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; }
        tr:hover { background: #f8fafc; }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge-verde { background: #d1fae5; color: #065f46; }
        .badge-amarelo { background: #fef3c7; color: #92400e; }
        .badge-vermelho { background: #fee2e2; color: #991b1b; }
        .badge-cinza { background: #f3f4f6; color: #374151; }
        .help-text { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .help-text h4 { color: #1e40af; margin-bottom: 10px; }
        .help-text ol { margin-left: 20px; color: #1e40af; }
        .help-text li { margin: 8px 0; font-size: 13px; }
        .new-badge { background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 10px; font-size: 10px; margin-left: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div><h1>üîß √Årea Administrativa <span class="version">v5.3.1</span></h1><p style="color:#64748b;font-size:13px;margin-top:5px;">KPIs Simplificados + Filtro Go-Live + Impress√£o por Projetos</p></div>
            <a href="index.html" class="btn btn-secondary">‚Üê Voltar</a>
        </div>
        <div id="successMsg" class="message success hidden"><span>‚úÖ</span><div><strong>Sucesso!</strong> <span id="successText"></span></div></div>
        <div id="errorMsg" class="message error hidden"><span>‚ùå</span><div><strong>Erro!</strong> <span id="errorText"></span></div></div>
        <div class="card">
            <div class="card-header"><h2>üìã Importar Dados da Planilha v5 <span class="new-badge">v5.3.1</span></h2></div>
            <div class="card-body">
                <div class="help-text">
                    <h4>üìù Novidades da vers√£o 5.3:</h4>
                    <ol>
                        <li><strong>KPIs simplificados</strong> - No Prazo, Atraso M√©dio, Projetos Atualizados, Tempo M√©dio Parado</li>
                        <li><strong>Filtro por Go-Live</strong> - Este m√™s, Pr√≥x. 30/60/90 dias, Atrasados</li>
                        <li><strong>Impress√£o por projetos</strong> - Selecione projetos espec√≠ficos pelo nome</li>
                        <li><strong>Sistema anti-burla</strong> - Detecta retrocesso de etapa</li>
                    </ol>
                </div>
                <div class="help-text" style="background:#f0fdf4;border-color:#86efac;">
                    <h4 style="color:#166534;">üìã Passo a passo para importar:</h4>
                    <ol style="color:#166534;">
                        <li>Abra a planilha <strong>Template_Projetos_v5.xlsx</strong></li>
                        <li>Selecione tudo: <strong>Ctrl+T</strong> (Excel Desktop) ou <strong>Ctrl+A</strong> (Excel Online)</li>
                        <li>Copie: <strong>Ctrl+C</strong></li>
                        <li>Cole no campo abaixo</li>
                        <li>Clique em <strong>"Carregar e Validar"</strong></li>
                    </ol>
                </div>
                <textarea id="dataInput" placeholder="Cole aqui os dados copiados da planilha Excel v5..."></textarea>
                <div class="action-buttons">
                    <button class="btn" onclick="processData()">üì• Carregar e Validar</button>
                    <button class="btn btn-secondary" onclick="clearData()">üóëÔ∏è Limpar</button>
                </div>
                <div id="validationSection" class="validation-section hidden">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                        <h3>üìã Valida√ß√£o</h3>
                        <span class="validation-status success" id="validationStatus">Verificando...</span>
                    </div>
                    <div id="validationItems"></div>
                </div>
                <div id="previewSection" class="preview-section hidden">
                    <h3>üëÄ Preview (<span id="previewCount">0</span>)</h3>
                    <div style="overflow-x:auto;margin-top:15px;">
                        <table><thead><tr><th>Projeto</th><th>Etapa</th><th>Progresso</th><th>Situa√ß√£o</th><th>Status</th><th>PMO Int</th><th>Go Live</th></tr></thead><tbody id="previewTable"></tbody></table>
                    </div>
                </div>
            </div>
        </div>
        <div id="exportCard" class="card hidden">
            <div class="card-header" style="background:linear-gradient(135deg,#10b981,#059669);"><h2>üì§ Exportar Dados</h2></div>
            <div class="card-body">
                <p style="margin-bottom:20px;color:#64748b;">Clique para baixar o <strong>dados.json</strong> e fazer upload no GitHub.</p>
                <button class="btn btn-success" onclick="exportJSON()">‚¨áÔ∏è Exportar dados.json</button>
            </div>
        </div>
    </div>
    <script>
        let projects = [];
        function showMessage(type, text) {
            const el = document.getElementById(type === 'success' ? 'successMsg' : 'errorMsg');
            document.getElementById(type === 'success' ? 'successText' : 'errorText').textContent = text;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }
        function clearData() {
            document.getElementById('dataInput').value = '';
            document.getElementById('validationSection').classList.add('hidden');
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('exportCard').classList.add('hidden');
            projects = [];
        }
        function processData() {
            try {
                const text = document.getElementById('dataInput').value;
                if (!text.trim()) { showMessage('error', 'Cole os dados da planilha primeiro!'); return; }
                projects = parseData(text);
                if (projects.length === 0) { showMessage('error', 'Nenhum projeto v√°lido encontrado!'); return; }
                localStorage.setItem('infraProjects', JSON.stringify(projects));
                showValidation();
                showPreview();
                document.getElementById('exportCard').classList.remove('hidden');
                showMessage('success', `${projects.length} projetos carregados com sucesso!`);
            } catch(e) { showMessage('error', 'Erro: ' + e.message); }
        }
        function parseData(text) {
            text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length < 2) return [];
            const data = [];
            const headers = lines[0].split('\t').map(h => h.trim().toLowerCase());
            
            // Mapeamento de colunas (v5)
            const colMap = {
                projeto: headers.findIndex(h => h.includes('projeto')),
                etapa: headers.findIndex(h => h.includes('etapa_atual') || h === 'etapa'),
                progresso: headers.findIndex(h => h.includes('progresso')),
                situacao: headers.findIndex(h => h.includes('situa√ß√£o') || h.includes('situacao')),
                status: headers.findIndex(h => h === 'status'),
                proximo: headers.findIndex(h => h.includes('proximo') || h.includes('pr√≥ximo')),
                bloqueador: headers.findIndex(h => h.includes('bloqueador')),
                goliveOriginal: headers.findIndex(h => h.includes('golive_original') || h.includes('original')),
                goliveAtual: headers.findIndex(h => h.includes('golive_atual') || h.includes('atual')),
                pmoInterno: headers.findIndex(h => h.includes('pmo_interno') || h === 'pmo interno'),
                infraInterno: headers.findIndex(h => h.includes('infra_interno') || h === 'infra interno'),
                pmoCliente: headers.findIndex(h => h.includes('pmo_cliente') || h === 'pmo cliente'),
                infraCliente: headers.findIndex(h => h.includes('infra_cliente') || h === 'infra cliente'),
                localizacao: headers.findIndex(h => h.includes('localizacao') || h.includes('localiza√ß√£o')),
                diasSemAtual: headers.findIndex(h => h.includes('dias')),
                ultAtual: headers.findIndex(h => h.includes('ultima') || h.includes('√∫ltima')),
                retrocesso: headers.findIndex(h => h.includes('retrocesso')),
                obs: headers.findIndex(h => h.includes('obs'))
            };
            
            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split('\t').map(c => c.trim());
                const projeto = cols[colMap.projeto] || cols[0];
                if (!projeto) continue;
                
                // Parse progresso (remove % se tiver)
                let progresso = 0;
                const progStr = cols[colMap.progresso] || cols[2] || '0';
                progresso = parseInt(progStr.replace('%', '').replace(',', '.')) || 0;
                
                data.push({
                    projeto: projeto,
                    etapa: cols[colMap.etapa] || cols[1] || '-',
                    progresso: progresso,
                    situacao: (cols[colMap.situacao] || cols[3] || 'Cinza').toLowerCase(),
                    status: cols[colMap.status] || cols[4] || 'N√£o Iniciado',
                    proximo: cols[colMap.proximo] || cols[5] || '-',
                    bloqueador: cols[colMap.bloqueador] || cols[6] || '-',
                    goliveOriginal: formatDate(cols[colMap.goliveOriginal] || cols[7]) || '-',
                    goliveAtual: formatDate(cols[colMap.goliveAtual] || cols[8]) || '-',
                    golive: formatDate(cols[colMap.goliveAtual] || cols[8]) || '-',
                    pmoInterno: cols[colMap.pmoInterno] || cols[9] || '-',
                    infraInterno: cols[colMap.infraInterno] || cols[10] || '-',
                    pmoCliente: cols[colMap.pmoCliente] || cols[11] || '-',
                    infraCliente: cols[colMap.infraCliente] || cols[12] || '-',
                    localizacao: cols[colMap.localizacao] || cols[13] || '-',
                    diasSemAtual: parseInt(cols[colMap.diasSemAtual] || cols[14] || '0') || 0,
                    ultAtual: formatDate(cols[colMap.ultAtual] || cols[15]) || '-',
                    retrocesso: cols[colMap.retrocesso] || cols[17] || '',
                    obs: cols[colMap.obs] || cols[18] || '-',
                    // Compatibilidade com vers√£o anterior
                    respInterno: cols[colMap.pmoInterno] || cols[9] || '-',
                    rag: (cols[colMap.situacao] || cols[3] || 'Cinza').toLowerCase()
                });
            }
            return data;
        }
        function formatDate(val) {
            if (!val || val === '-' || val === '') return null;
            if (typeof val === 'number') {
                const d = new Date((val - 25569) * 86400 * 1000);
                return d.toLocaleDateString('pt-BR');
            }
            if (val.includes('/')) return val;
            if (val.includes('-')) {
                const parts = val.split(/[-T ]/);
                if (parts[0].length === 4) return `${parts[2].substring(0,2)}/${parts[1]}/${parts[0]}`;
            }
            return val;
        }
        function showValidation() {
            const section = document.getElementById('validationSection');
            const items = document.getElementById('validationItems');
            const parados = projects.filter(p => p.diasSemAtual > 15).length;
            const retrocessos = projects.filter(p => p.retrocesso && p.retrocesso.includes('RETROCESSO')).length;
            let html = `<div class="validation-item ok">‚úÖ ${projects.length} projetos encontrados</div>`;
            if (parados > 0) html += `<div class="validation-item warning">‚ö†Ô∏è ${parados} projeto(s) parado(s) h√° mais de 15 dias</div>`;
            if (retrocessos > 0) html += `<div class="validation-item warning">‚ö†Ô∏è ${retrocessos} projeto(s) com retrocesso de etapa</div>`;
            items.innerHTML = html;
            document.getElementById('validationStatus').textContent = 'Tudo OK!';
            section.classList.remove('hidden');
        }
        function showPreview() {
            document.getElementById('previewCount').textContent = `${projects.length} projetos`;
            document.getElementById('previewTable').innerHTML = projects.slice(0, 15).map(p => `<tr>
                <td><strong>${p.projeto}</strong></td>
                <td>${p.etapa}</td>
                <td>${p.progresso}%</td>
                <td><span class="badge badge-${p.situacao}">${p.situacao}</span></td>
                <td>${p.status}</td>
                <td>${p.pmoInterno}</td>
                <td>${p.goliveAtual}</td>
            </tr>`).join('');
            document.getElementById('previewSection').classList.remove('hidden');
        }
        function exportJSON() {
            const data = { lastUpdate: new Date().toISOString(), version: '5.3', projects: projects };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dados.json';
            a.click();
            URL.revokeObjectURL(url);
            showMessage('success', 'Arquivo dados.json exportado!');
        }
    </script>
</body>
</html>
