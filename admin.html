<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Dashboard Projetos v6.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 25px 30px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); margin-bottom: 25px; }
        .header h1 { color: #1a1a2e; font-size: 1.5rem; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .version { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .header-actions { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-primary:hover { box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-success:hover { box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .btn-danger:hover { box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .btn-warning:hover { box-shadow: 0 5px 20px rgba(245, 158, 11, 0.4); }

        .card { background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); margin-bottom: 25px; overflow: hidden; }
        .card-header { background: linear-gradient(135deg, #1e293b, #334155); padding: 20px 25px; color: white; }
        .card-header h2 { font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .card-body { padding: 25px; }

        .upload-zone { border: 3px dashed #cbd5e1; border-radius: 16px; padding: 50px 30px; text-align: center; transition: all 0.3s; cursor: pointer; background: #f8fafc; }
        .upload-zone:hover, .upload-zone.dragover { border-color: #667eea; background: #eef2ff; }
        .upload-zone .icon { font-size: 4rem; margin-bottom: 15px; }
        .upload-zone h3 { color: #1e293b; margin-bottom: 10px; }
        .upload-zone p { color: #64748b; font-size: 0.9rem; }
        .upload-zone input { display: none; }

        .msg { padding: 15px 20px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .msg.success { background: #dcfce7; color: #166534; border-left: 4px solid #22c55e; }
        .msg.error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .msg.info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
        .msg.warning { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
        .hidden { display: none !important; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 20px; border-radius: 12px; text-align: center; }
        .stat-box .number { font-size: 2rem; font-weight: 700; color: #1e293b; }
        .stat-box .label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; margin-top: 5px; }
        .stat-box.green .number { color: #22c55e; }
        .stat-box.blue .number { color: #3b82f6; }
        .stat-box.red .number { color: #ef4444; }
        .stat-box.yellow .number { color: #f59e0b; }

        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; font-weight: 600; color: #475569; text-transform: uppercase; font-size: 0.7rem; }
        tr:hover { background: #f8fafc; }
        
        .badge { padding: 4px 10px; border-radius: 15px; font-size: 0.7rem; font-weight: 600; }
        .badge.green { background: #dcfce7; color: #166534; }
        .badge.blue { background: #dbeafe; color: #1e40af; }
        .badge.red { background: #fee2e2; color: #991b1b; }
        .badge.yellow { background: #fef3c7; color: #92400e; }

        .footer-links { display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .footer-links a { color: white; text-decoration: none; padding: 10px 20px; background: rgba(255,255,255,0.1); border-radius: 10px; transition: all 0.3s; }
        .footer-links a:hover { background: rgba(255,255,255,0.2); }
        
        .dashboard-footer { text-align: center; padding: 20px; color: rgba(255,255,255,0.6); font-size: 0.8rem; margin-top: 20px; }

        @media (max-width: 768px) {
            .header-actions { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è Administra√ß√£o <span class="version">v6.2</span></h1>
            <div class="header-actions">
                <a href="index.html" class="btn btn-primary">üè† In√≠cio</a>
                <a href="view-simples.html" class="btn btn-success">üìä Vis√£o Resumida</a>
                <a href="view-detalhada.html" class="btn btn-warning">üìã Vis√£o Detalhada</a>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>üì§ Importar Planilha Excel</h2>
            </div>
            <div class="card-body">
                <div id="successMsg" class="msg success hidden">‚úÖ <span id="successText"></span></div>
                <div id="errorMsg" class="msg error hidden">‚ùå <span id="errorText"></span></div>
                <div id="infoMsg" class="msg info hidden">‚ÑπÔ∏è <span id="infoText"></span></div>
                <div id="warningMsg" class="msg warning hidden">‚ö†Ô∏è <span id="warningText"></span></div>

                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <div class="icon">üìÅ</div>
                    <h3>Arraste o arquivo Excel aqui</h3>
                    <p>ou clique para selecionar ‚Ä¢ Formato: .xlsx com abas "Projetos" e "Atividades"</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFile(this.files[0])">
                </div>

                <div id="fileInfo" class="hidden" style="margin-top: 20px; padding: 15px; background: #f0fdf4; border-radius: 10px; border-left: 4px solid #22c55e;">
                    <strong>üìÑ Arquivo:</strong> <span id="fileName"></span><br>
                    <strong>üìÖ Carregado em:</strong> <span id="loadTime"></span>
                </div>
            </div>
        </div>

        <div class="card hidden" id="statsCard">
            <div class="card-header">
                <h2>üìä Resumo dos Dados</h2>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-box"><div class="number" id="statTotal">0</div><div class="label">Total Projetos</div></div>
                    <div class="stat-box green"><div class="number" id="statConcluidos">0</div><div class="label">Conclu√≠dos</div></div>
                    <div class="stat-box blue"><div class="number" id="statAndamento">0</div><div class="label">Em Andamento</div></div>
                    <div class="stat-box red"><div class="number" id="statCriticos">0</div><div class="label">Cr√≠ticos</div></div>
                    <div class="stat-box yellow"><div class="number" id="statAtividades">0</div><div class="label">Atividades</div></div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Projeto</th>
                                <th>Status</th>
                                <th>Situa√ß√£o</th>
                                <th>Progresso</th>
                                <th>Atividades</th>
                                <th>PMO</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTable"></tbody>
                    </table>
                </div>

                <div style="margin-top: 25px; display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="exportJSON()">üíæ Exportar dados.json</button>
                    <button class="btn btn-danger" onclick="clearData()">üóëÔ∏è Limpar Dados</button>
                </div>
            </div>
        </div>

        <div class="footer-links">
            <a href="index.html">üè† P√°gina Inicial</a>
            <a href="view-simples.html">üìä Vis√£o Resumida</a>
            <a href="view-detalhada.html">üìã Vis√£o Detalhada</a>
        </div>
        
        <footer class="dashboard-footer">
            Dashboard Projetos Infraestrutura ¬∑ v6.2 ¬∑ Administra√ß√£o
        </footer>
    </div>

    <script>
        let projects = [];
        let atividades = [];
        let dadosCompletos = null;

        const uploadZone = document.getElementById('uploadZone');
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        function showMessage(type, text) {
            ['success', 'error', 'info', 'warning'].forEach(t => {
                document.getElementById(t + 'Msg').classList.add('hidden');
            });
            const el = document.getElementById(type + 'Msg');
            document.getElementById(type + 'Text').innerHTML = text;
            el.classList.remove('hidden');
            if (type !== 'error') setTimeout(() => el.classList.add('hidden'), 8000);
        }

        function handleFile(file) {
            if (!file) return;
            
            const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel'];
            if (!validTypes.includes(file.type) && !file.name.match(/\.xlsx?$/i)) {
                showMessage('error', 'Arquivo inv√°lido. Use formato .xlsx ou .xls');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Verificar abas
                    const sheetNames = workbook.SheetNames.map(s => s.toLowerCase());
                    const projetosSheet = workbook.SheetNames.find(s => s.toLowerCase() === 'projetos');
                    const atividadesSheet = workbook.SheetNames.find(s => s.toLowerCase() === 'atividades');

                    if (!projetosSheet) {
                        showMessage('error', 'Aba "Projetos" n√£o encontrada na planilha.');
                        return;
                    }

                    // Processar Projetos
                    const projetosData = XLSX.utils.sheet_to_json(workbook.Sheets[projetosSheet]);
                    projects = projetosData.map(row => ({
                        projeto: row['Projeto'] || row['projeto'] || '',
                        localizacao: row['Localiza√ß√£o'] || row['localizacao'] || row['Local'] || '',
                        status: row['Status'] || row['status'] || 'N√£o Iniciado',
                        situacao: row['Situa√ß√£o'] || row['situacao'] || row['RAG'] || 'Verde',
                        pmoInterno: row['PMO Interno'] || row['pmoInterno'] || row['PMO'] || '',
                        goLiveOriginal: formatDate(row['Go Live Original'] || row['goLiveOriginal'] || row['GoLive Original']),
                        goLiveAtual: formatDate(row['Go Live Atual'] || row['goLiveAtual'] || row['GoLive Atual']),
                        bloqueador: row['Bloqueador'] || row['bloqueador'] || '',
                        observacoes: row['Observa√ß√µes'] || row['observacoes'] || row['Obs'] || '',
                        progresso: 0,
                        diasParado: 0
                    }));

                    // Processar Atividades
                    atividades = [];
                    if (atividadesSheet) {
                        const atividadesData = XLSX.utils.sheet_to_json(workbook.Sheets[atividadesSheet]);
                        atividades = atividadesData.map(row => ({
                            projeto: row['Projeto'] || row['projeto'] || '',
                            atividade: row['Atividade'] || row['atividade'] || '',
                            status: row['Status'] || row['status'] || 'Pendente',
                            dataInicio: formatDate(row['Data In√≠cio'] || row['dataInicio'] || row['In√≠cio']),
                            dataConclusao: formatDate(row['Data Conclus√£o'] || row['dataConclusao'] || row['Conclus√£o']),
                            dias: row['Dias'] || row['dias'] || 0
                        }));
                    }

                    // Calcular progresso e dias parado
                    projects.forEach(p => {
                        const ativsProjeto = atividades.filter(a => a.projeto === p.projeto);
                        if (ativsProjeto.length > 0) {
                            const concluidas = ativsProjeto.filter(a => 
                                (a.status || '').toLowerCase().includes('conclu') ||
                                (a.status || '').toLowerCase() === 'c'
                            ).length;
                            p.progresso = Math.round((concluidas / ativsProjeto.length) * 100);
                        }
                        
                        // Calcular dias parado
                        const ultimaAtividade = atividades
                            .filter(a => a.projeto === p.projeto && a.dataConclusao)
                            .sort((a, b) => {
                                const dateA = new Date(a.dataConclusao.split('/').reverse().join('-'));
                                const dateB = new Date(b.dataConclusao.split('/').reverse().join('-'));
                                return dateB - dateA;
                            })[0];
                        
                        if (ultimaAtividade && ultimaAtividade.dataConclusao) {
                            const ultData = new Date(ultimaAtividade.dataConclusao.split('/').reverse().join('-'));
                            const hoje = new Date();
                            p.diasParado = Math.floor((hoje - ultData) / (1000 * 60 * 60 * 24));
                        }
                    });

                    dadosCompletos = {
                        projetos: projects,
                        atividades: atividades,
                        ultimaAtualizacao: new Date().toLocaleString('pt-BR')
                    };

                    localStorage.setItem('dashboardData', JSON.stringify(dadosCompletos));
                    localStorage.setItem('infraDashboard', JSON.stringify(dadosCompletos));

                    showStats();
                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('loadTime').textContent = new Date().toLocaleString('pt-BR');
                    document.getElementById('fileInfo').classList.remove('hidden');
                    showMessage('success', `Planilha carregada! ${projects.length} projetos e ${atividades.length} atividades.`);

                } catch (error) {
                    console.error(error);
                    showMessage('error', 'Erro ao processar arquivo: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function formatDate(value) {
            if (!value) return '';
            if (typeof value === 'number') {
                const date = XLSX.SSF.parse_date_code(value);
                return `${String(date.d).padStart(2, '0')}/${String(date.m).padStart(2, '0')}/${date.y}`;
            }
            return String(value);
        }

        function normalizeStatus(status) {
            if (!status) return 'N√£o Iniciado';
            const s = status.toLowerCase().trim();
            if (s.includes('conclu')) return 'Conclu√≠do';
            if (s.includes('andamento')) return 'Em Andamento';
            if (s.includes('atrasa')) return 'Atrasado';
            if (s.includes('aguard') || s.includes('cliente')) return 'Aguardando';
            return 'N√£o Iniciado';
        }

        function isCritico(p) {
            const status = normalizeStatus(p.status);
            const situacao = (p.situacao || '').toLowerCase();
            const diasParado = parseInt(p.diasParado) || 0;
            const temBloqueador = p.bloqueador && p.bloqueador !== '-' && p.bloqueador.trim() !== '';
            return status === 'Atrasado' || situacao === 'vermelho' || diasParado >= 15 || temBloqueador;
        }

        function showStats() {
            document.getElementById('statsCard').classList.remove('hidden');
            
            const stats = { total: projects.length, concluidos: 0, andamento: 0, criticos: 0 };
            projects.forEach(p => {
                const status = normalizeStatus(p.status);
                if (status === 'Conclu√≠do') stats.concluidos++;
                else if (status === 'Em Andamento') stats.andamento++;
                if (isCritico(p)) stats.criticos++;
            });

            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statConcluidos').textContent = stats.concluidos;
            document.getElementById('statAndamento').textContent = stats.andamento;
            document.getElementById('statCriticos').textContent = stats.criticos;
            document.getElementById('statAtividades').textContent = atividades.length;

            const tbody = document.getElementById('projectsTable');
            tbody.innerHTML = projects.map(p => {
                const status = normalizeStatus(p.status);
                const statusClass = status === 'Conclu√≠do' ? 'green' : status === 'Em Andamento' ? 'blue' : status === 'Atrasado' ? 'red' : 'yellow';
                const situacaoClass = (p.situacao || '').toLowerCase() === 'verde' ? 'green' : (p.situacao || '').toLowerCase() === 'amarelo' ? 'yellow' : 'red';
                const ativsProjeto = atividades.filter(a => a.projeto === p.projeto).length;
                
                return `<tr>
                    <td><strong>${p.projeto}</strong></td>
                    <td><span class="badge ${statusClass}">${status}</span></td>
                    <td><span class="badge ${situacaoClass}">${p.situacao || 'Verde'}</span></td>
                    <td>${p.progresso}%</td>
                    <td>${ativsProjeto}</td>
                    <td>${p.pmoInterno || '-'}</td>
                </tr>`;
            }).join('');
        }

        function exportJSON() {
            if (!dadosCompletos || projects.length === 0) {
                showMessage('warning', 'Nenhum dado para exportar. Importe uma planilha primeiro.');
                return;
            }

            dadosCompletos.ultimaAtualizacao = new Date().toLocaleString('pt-BR');
            const json = JSON.stringify(dadosCompletos, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dados.json';
            a.click();
            URL.revokeObjectURL(url);
            showMessage('success', 'Arquivo dados.json exportado! Coloque na mesma pasta das views.');
        }

        function clearData() {
            if (!confirm('Tem certeza que deseja limpar todos os dados?')) return;
            projects = [];
            atividades = [];
            dadosCompletos = null;
            localStorage.removeItem('infraDashboard');
            localStorage.removeItem('dashboardData');
            document.getElementById('statsCard').classList.add('hidden');
            document.getElementById('fileInfo').classList.add('hidden');
            showMessage('info', 'Dados limpos. Importe uma nova planilha.');
        }

        window.addEventListener('load', () => {
            const saved = localStorage.getItem('dashboardData') || localStorage.getItem('infraDashboard');
            if (saved) {
                try {
                    dadosCompletos = JSON.parse(saved);
                    projects = dadosCompletos.projetos || dadosCompletos.projects || [];
                    atividades = dadosCompletos.atividades || [];
                    if (projects.length > 0) {
                        showStats();
                        showMessage('info', `Dados anteriores carregados: ${projects.length} projetos e ${atividades.length} atividades.`);
                    }
                } catch (e) { console.error(e); }
            }
        });
    </script>
</body>
</html>
