<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Dashboard Projetos v6.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 25px 30px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); margin-bottom: 25px; }
        .header h1 { color: #1a1a2e; font-size: 24px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .version { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .new-tag { background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .subtitle { color: #64748b; font-size: 13px; margin-top: 8px; }
        .btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 14px 28px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102,126,234,0.4); }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .card { background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); margin-bottom: 25px; overflow: hidden; }
        .card-header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px 25px; }
        .card-header h2 { font-size: 18px; display: flex; align-items: center; gap: 12px; }
        .card-body { padding: 25px; }
        .upload-zone { border: 3px dashed #e2e8f0; border-radius: 16px; padding: 50px; text-align: center; transition: all 0.3s; cursor: pointer; background: #f8fafc; }
        .upload-zone:hover, .upload-zone.dragover { border-color: #667eea; background: #eff6ff; }
        .upload-zone h3 { color: #1e293b; margin-bottom: 10px; font-size: 18px; }
        .upload-zone p { color: #64748b; font-size: 13px; margin-bottom: 20px; }
        .upload-zone input { display: none; }
        .upload-icon { font-size: 48px; margin-bottom: 15px; }
        .message { padding: 16px 20px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        .message.success { background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; border-left: 4px solid #10b981; }
        .message.error { background: linear-gradient(135deg, #fee2e2, #fecaca); color: #991b1b; border-left: 4px solid #ef4444; }
        .message.info { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1e40af; border-left: 4px solid #3b82f6; }
        .hidden { display: none; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 12px; padding: 20px; text-align: center; border: 1px solid #e2e8f0; }
        .stat-card .icon { font-size: 28px; margin-bottom: 8px; }
        .stat-card .number { font-size: 32px; font-weight: 800; color: #1e293b; }
        .stat-card .label { font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card.projetos .number { color: #667eea; }
        .stat-card.atividades .number { color: #10b981; }
        .stat-card.concluidas .number { color: #059669; }
        .stat-card.pendentes .number { color: #f59e0b; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 10px; text-align: left; font-weight: 600; }
        td { padding: 10px; border-bottom: 1px solid #e5e7eb; }
        tr:hover { background: #f8fafc; }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 600; }
        .badge-verde { background: #d1fae5; color: #065f46; }
        .badge-amarelo { background: #fef3c7; color: #92400e; }
        .badge-vermelho { background: #fee2e2; color: #991b1b; }
        .badge-cinza { background: #f3f4f6; color: #374151; }
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 13px; font-weight: 600; background: #e2e8f0; color: #64748b; transition: all 0.3s; }
        .tab.active { background: #667eea; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .progress-bar { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #10b981, #059669); transition: width 0.5s; }
        .action-buttons { display: flex; gap: 15px; flex-wrap: wrap; }
        .footer-links { margin-top: 20px; text-align: center; }
        .footer-links a { color: white; text-decoration: none; margin: 0 15px; font-size: 13px; opacity: 0.8; }
        .footer-links a:hover { opacity: 1; }
        .timestamp { color: #64748b; font-size: 12px; margin-top: 10px; }
        @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                üîß √Årea Administrativa 
                <span class="version">v6.0</span>
                <span class="new-tag">‚ú® Nova Arquitetura</span>
            </h1>
            <p class="subtitle">Importa√ß√£o de arquivo Excel com m√∫ltiplas atividades por projeto ‚Ä¢ An√°lise detalhada de atividades</p>
            <p class="timestamp" id="currentTime"></p>
        </div>

        <div id="successMsg" class="message success hidden"><span>‚úÖ</span><div id="successText"></div></div>
        <div id="errorMsg" class="message error hidden"><span>‚ùå</span><div id="errorText"></div></div>
        <div id="infoMsg" class="message info hidden"><span>‚ÑπÔ∏è</span><div id="infoText"></div></div>

        <div class="card">
            <div class="card-header">
                <h2>üìÅ Importar Planilha v6.0</h2>
            </div>
            <div class="card-body">
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üìä</div>
                    <h3>Arraste o arquivo Excel aqui</h3>
                    <p>ou clique para selecionar ‚Ä¢ Template_Projetos_v6.xlsx</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFile(this.files[0])">
                    <button class="btn" onclick="event.stopPropagation();">üìÇ Selecionar Arquivo</button>
                </div>
                
                <div id="fileInfo" class="message info hidden" style="margin-top:20px;">
                    <span>üìÑ</span>
                    <div>
                        <strong id="fileName">-</strong><br>
                        <small id="fileDetails">-</small>
                    </div>
                </div>
            </div>
        </div>

        <div id="statsCard" class="card hidden">
            <div class="card-header" style="background: linear-gradient(135deg, #10b981, #059669);">
                <h2>üìä Resumo da Importa√ß√£o</h2>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-card projetos">
                        <div class="icon">üìÅ</div>
                        <div class="number" id="statProjetos">0</div>
                        <div class="label">Projetos</div>
                    </div>
                    <div class="stat-card atividades">
                        <div class="icon">üìã</div>
                        <div class="number" id="statAtividades">0</div>
                        <div class="label">Atividades</div>
                    </div>
                    <div class="stat-card concluidas">
                        <div class="icon">‚úÖ</div>
                        <div class="number" id="statConcluidas">0</div>
                        <div class="label">Conclu√≠das</div>
                    </div>
                    <div class="stat-card pendentes">
                        <div class="icon">‚è≥</div>
                        <div class="number" id="statPendentes">0</div>
                        <div class="label">Pendentes</div>
                    </div>
                </div>
                
                <div class="tabs">
                    <div class="tab active" onclick="showTab('projetos')">üìÅ Projetos</div>
                    <div class="tab" onclick="showTab('atividades')">üìã Atividades</div>
                    <div class="tab" onclick="showTab('analise')">üìà An√°lise</div>
                </div>
                
                <div id="tabProjetos" class="tab-content active">
                    <table>
                        <thead>
                            <tr><th>Projeto</th><th>Status</th><th>Situa√ß√£o</th><th>Progresso</th><th>PMO</th><th>Go Live</th><th>Atividades</th></tr>
                        </thead>
                        <tbody id="tabelaProjetos"></tbody>
                    </table>
                </div>
                
                <div id="tabAtividades" class="tab-content">
                    <table>
                        <thead>
                            <tr><th>ID</th><th>Projeto</th><th>Atividade</th><th>Status</th><th>Respons√°vel</th><th>In√≠cio</th><th>Fim</th><th>Dias</th></tr>
                        </thead>
                        <tbody id="tabelaAtividades"></tbody>
                    </table>
                </div>
                
                <div id="tabAnalise" class="tab-content">
                    <h4 style="margin-bottom:15px;">üî• Top 5 Atividades que Mais Atrasam</h4>
                    <table>
                        <thead>
                            <tr><th>Atividade</th><th>M√©dia de Dias</th><th>Qtd Projetos</th><th>Impacto</th></tr>
                        </thead>
                        <tbody id="tabelaAnalise"></tbody>
                    </table>
                </div>
                
                <div class="action-buttons" style="margin-top:25px;">
                    <button class="btn btn-success" onclick="exportJSON()">‚¨áÔ∏è Exportar dados.json</button>
                    <button class="btn btn-danger" onclick="clearData()">üóëÔ∏è Limpar Dados</button>
                </div>
            </div>
        </div>
        
        <div class="footer-links">
            <a href="index.html">üè† P√°gina Inicial</a>
            <a href="view-simples.html">üìã Vis√£o Resumida</a>
            <a href="view-detalhada.html">üìà Vis√£o Detalhada</a>
        </div>
    </div>

    <script>
        let projects = [];
        let atividades = [];
        let dadosCompletos = null;

        // Atualizar hora atual
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 'üïê ' + now.toLocaleDateString('pt-BR') + ', ' + now.toLocaleTimeString('pt-BR');
        }
        updateTime();
        setInterval(updateTime, 1000);

        // Drag and drop
        const uploadZone = document.getElementById('uploadZone');
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });

        function showMessage(type, text) {
            const ids = { success: 'successMsg', error: 'errorMsg', info: 'infoMsg' };
            const textIds = { success: 'successText', error: 'errorText', info: 'infoText' };
            Object.values(ids).forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(ids[type]).classList.remove('hidden');
            document.getElementById(textIds[type]).innerHTML = text;
            if (type !== 'info') setTimeout(() => document.getElementById(ids[type]).classList.add('hidden'), 5000);
        }

        function handleFile(file) {
            if (!file) return;
            
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileDetails').textContent = `${(file.size / 1024).toFixed(1)} KB`;
            document.getElementById('fileInfo').classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    
                    // Verificar abas
                    const sheetNames = workbook.SheetNames.map(s => s.toLowerCase());
                    const hasProjetosSheet = sheetNames.some(s => s.includes('projeto'));
                    const hasAtividadesSheet = sheetNames.some(s => s.includes('atividade'));
                    
                    if (!hasProjetosSheet) {
                        showMessage('error', 'Aba "Projetos" n√£o encontrada na planilha!');
                        return;
                    }
                    
                    // Encontrar nomes reais das abas
                    const projetosSheetName = workbook.SheetNames.find(s => s.toLowerCase().includes('projeto'));
                    const atividadesSheetName = workbook.SheetNames.find(s => s.toLowerCase().includes('atividade'));
                    
                    // Ler aba Projetos
                    const wsProjetos = workbook.Sheets[projetosSheetName];
                    const rawProjetos = XLSX.utils.sheet_to_json(wsProjetos, { raw: false });
                    
                    projects = rawProjetos.map(row => ({
                        projeto: row['Projeto'] || row['projeto'] || '-',
                        localizacao: row['Localiza√ß√£o'] || row['localizacao'] || row['Localiza√ß√£o do CD'] || '-',
                        status: normalizeStatus(row['Status'] || row['status'] || row['Status Atual'] || 'N√£o Iniciado'),
                        situacao: (row['Situa√ß√£o'] || row['situacao'] || row['Situa√ß√£o/RAG'] || 'Cinza').toLowerCase(),
                        progresso: parseInt(String(row['Progresso'] || row['progresso'] || '0').replace('%', '')) || 0,
                        pmoInterno: row['PMO Interno'] || row['pmoInterno'] || row['Respons√°vel'] || '-',
                        goliveOriginal: formatDateBR(row['Go Live Original'] || row['goliveOriginal'] || row['Data Go Live'] || ''),
                        goliveAtual: formatDateBR(row['Go Live Atual'] || row['goliveAtual'] || row['Go Live Alterado'] || ''),
                        bloqueador: cleanBloqueador(row['Bloqueador'] || row['bloqueador'] || ''),
                        ultAtual: formatDateBR(row['√öltima Atualiza√ß√£o'] || row['ultAtual'] || ''),
                        diasSemAtual: parseInt(row['Dias Parado'] || row['diasSemAtual'] || row['Dias Sem Atualiza√ß√£o'] || '0') || 0,
                        observacoes: row['Observa√ß√µes'] || row['observacoes'] || '-',
                        atividades: [] // Ser√° preenchido depois
                    }));
                    
                    // Ler aba Atividades (se existir)
                    atividades = [];
                    if (atividadesSheetName) {
                        const wsAtividades = workbook.Sheets[atividadesSheetName];
                        const rawAtividades = XLSX.utils.sheet_to_json(wsAtividades, { raw: false });
                        
                        atividades = rawAtividades.map(row => ({
                            id: row['ID'] || row['id'] || '',
                            projeto: row['Projeto'] || row['projeto'] || '',
                            atividade: row['Atividade'] || row['atividade'] || '',
                            status: row['Status'] || row['status'] || 'Pendente',
                            responsavel: row['Respons√°vel'] || row['responsavel'] || '-',
                            dataInicio: formatDateBR(row['Data In√≠cio'] || row['dataInicio'] || ''),
                            dataFim: formatDateBR(row['Data Fim'] || row['dataFim'] || ''),
                            diasDuracao: parseInt(row['Dias Dura√ß√£o'] || row['diasDuracao'] || '0') || 0,
                            observacoes: row['Observa√ß√µes'] || row['observacoes'] || ''
                        }));
                        
                        // Vincular atividades aos projetos
                        projects.forEach(p => {
                            p.atividades = atividades.filter(a => 
                                a.projeto.toLowerCase().trim() === p.projeto.toLowerCase().trim()
                            );
                        });
                    }
                    
                    // Calcular dias parado automaticamente se necess√°rio
                    projects.forEach(p => {
                        if (p.diasSemAtual === 0 && p.ultAtual) {
                            p.diasSemAtual = calcularDiasParado(p.ultAtual);
                        }
                    });
                    
                    // Salvar no localStorage
                    dadosCompletos = { projects, atividades, lastUpdate: new Date().toISOString(), version: '6.0' };
                    localStorage.setItem('infraDashboard', JSON.stringify(dadosCompletos));
                    
                    // Mostrar estat√≠sticas
                    showStats();
                    showMessage('success', `<strong>Importa√ß√£o conclu√≠da!</strong> ${projects.length} projetos e ${atividades.length} atividades carregados.`);
                    
                } catch (err) {
                    console.error(err);
                    showMessage('error', 'Erro ao processar arquivo: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function normalizeStatus(status) {
            if (!status) return 'N√£o Iniciado';
            const s = status.toLowerCase().trim();
            if (s.includes('conclu')) return 'Conclu√≠do';
            if (s.includes('andamento')) return 'Em Andamento';
            if (s.includes('atras')) return 'Atrasado';
            if (s.includes('aguard')) return 'Aguardando Cliente';
            if (s.includes('n√£o') || s.includes('nao') || s.includes('inicio')) return 'N√£o Iniciado';
            return status;
        }

        function formatDateBR(val) {
            if (!val || val === '-' || val === '' || val === 'NaN' || val === 'A definir') return '';
            
            // Se j√° for Date
            if (val instanceof Date) {
                return val.toLocaleDateString('pt-BR');
            }
            
            const str = String(val).trim();
            
            // J√° est√° em dd/mm/aaaa
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(str)) {
                const parts = str.split('/');
                return `${parts[0].padStart(2, '0')}/${parts[1].padStart(2, '0')}/${parts[2]}`;
            }
            
            // Formato aaaa-mm-dd
            if (/^\d{4}-\d{2}-\d{2}/.test(str)) {
                const parts = str.split(/[-T ]/);
                return `${parts[2].substring(0,2)}/${parts[1]}/${parts[0]}`;
            }
            
            return str;
        }

        function cleanBloqueador(val) {
            if (!val || val === '-' || val === '' || val === 'NaN' || val === 'undefined') return '';
            return String(val).trim();
        }

        function calcularDiasParado(ultAtualStr) {
            if (!ultAtualStr) return 0;
            const parts = ultAtualStr.split('/');
            if (parts.length !== 3) return 0;
            const ultAtual = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
            const hoje = new Date();
            const diff = Math.floor((hoje - ultAtual) / (1000 * 60 * 60 * 24));
            return diff >= 0 ? diff : 0;
        }

        function showStats() {
            document.getElementById('statsCard').classList.remove('hidden');
            
            const concluidas = atividades.filter(a => a.status.toLowerCase().includes('conclu')).length;
            const pendentes = atividades.length - concluidas;
            
            document.getElementById('statProjetos').textContent = projects.length;
            document.getElementById('statAtividades').textContent = atividades.length;
            document.getElementById('statConcluidas').textContent = concluidas;
            document.getElementById('statPendentes').textContent = pendentes;
            
            // Tabela Projetos
            document.getElementById('tabelaProjetos').innerHTML = projects.map(p => {
                const atvTotal = p.atividades.length;
                const atvConcl = p.atividades.filter(a => a.status.toLowerCase().includes('conclu')).length;
                return `<tr>
                    <td><strong>${p.projeto}</strong></td>
                    <td>${p.status}</td>
                    <td><span class="badge badge-${p.situacao}">${p.situacao}</span></td>
                    <td>
                        <div class="progress-bar" style="width:80px;"><div class="progress-fill" style="width:${p.progresso}%"></div></div>
                        <small>${p.progresso}%</small>
                    </td>
                    <td>${p.pmoInterno}</td>
                    <td>${p.goliveAtual || p.goliveOriginal || '-'}</td>
                    <td><strong>${atvConcl}</strong>/${atvTotal}</td>
                </tr>`;
            }).join('');
            
            // Tabela Atividades (primeiras 50)
            document.getElementById('tabelaAtividades').innerHTML = atividades.slice(0, 50).map(a => `<tr>
                <td>${a.id}</td>
                <td>${a.projeto}</td>
                <td>${a.atividade}</td>
                <td><span class="badge badge-${a.status.toLowerCase().includes('conclu') ? 'verde' : a.status.toLowerCase().includes('andamento') ? 'amarelo' : 'cinza'}">${a.status}</span></td>
                <td>${a.responsavel}</td>
                <td>${a.dataInicio || '-'}</td>
                <td>${a.dataFim || '-'}</td>
                <td>${a.diasDuracao || '-'}</td>
            </tr>`).join('');
            
            // An√°lise - Top 5 atividades que mais atrasam
            const atividadeStats = {};
            atividades.forEach(a => {
                if (a.diasDuracao > 0) {
                    if (!atividadeStats[a.atividade]) {
                        atividadeStats[a.atividade] = { total: 0, dias: 0, count: 0 };
                    }
                    atividadeStats[a.atividade].total += a.diasDuracao;
                    atividadeStats[a.atividade].count++;
                }
            });
            
            const ranking = Object.entries(atividadeStats)
                .map(([nome, stats]) => ({
                    nome,
                    media: Math.round(stats.total / stats.count),
                    count: stats.count
                }))
                .sort((a, b) => b.media - a.media)
                .slice(0, 5);
            
            document.getElementById('tabelaAnalise').innerHTML = ranking.length > 0 ? ranking.map((r, i) => `<tr>
                <td><strong>${r.nome}</strong></td>
                <td>${r.media} dias</td>
                <td>${r.count} projetos</td>
                <td><span class="badge badge-${r.media > 5 ? 'vermelho' : r.media > 3 ? 'amarelo' : 'verde'}">${r.media > 5 ? 'Alto' : r.media > 3 ? 'M√©dio' : 'Baixo'}</span></td>
            </tr>`).join('') : '<tr><td colspan="4" style="text-align:center;color:#64748b;">Sem dados de dura√ß√£o para an√°lise</td></tr>';
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
        }

        function exportJSON() {
            if (!dadosCompletos) {
                showMessage('error', 'Nenhum dado para exportar!');
                return;
            }
            
            dadosCompletos.lastUpdate = new Date().toISOString();
            const blob = new Blob([JSON.stringify(dadosCompletos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dados.json';
            a.click();
            URL.revokeObjectURL(url);
            showMessage('success', '<strong>Exportado!</strong> Arquivo dados.json baixado com sucesso.');
        }

        function clearData() {
            projects = [];
            atividades = [];
            dadosCompletos = null;
            localStorage.removeItem('infraDashboard');
            document.getElementById('statsCard').classList.add('hidden');
            document.getElementById('fileInfo').classList.add('hidden');
            showMessage('info', 'Dados limpos. Importe uma nova planilha.');
        }

        // Carregar dados salvos ao iniciar
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('infraDashboard');
            if (saved) {
                try {
                    dadosCompletos = JSON.parse(saved);
                    projects = dadosCompletos.projects || [];
                    atividades = dadosCompletos.atividades || [];
                    if (projects.length > 0) {
                        showStats();
                        showMessage('info', `Dados anteriores carregados: ${projects.length} projetos e ${atividades.length} atividades.`);
                    }
                } catch (e) { console.error(e); }
            }
        });
    </script>
</body>
</html>
