<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Infraestrutura v7.2.1 - Vis√£o Macro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            opacity: 0.9;
            font-size: 0.95em;
        }
        
        .controls {
            padding: 25px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        /* TOGGLE VIS√ÉO EXECUTIVA/PROJETO */
        .view-toggle {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .view-toggle button {
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            border: 2px solid #667eea;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            color: #667eea;
        }
        
        .view-toggle button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }
        
        .view-toggle button:hover:not(.active) {
            background: #f0f0f0;
            transform: translateY(-2px);
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .filter-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.9em;
        }
        
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.95em;
            transition: border-color 0.3s;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .content {
            padding: 30px;
        }
        
        /* CARDS VIS√ÉO EXECUTIVA */
        .macro-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .macro-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid #667eea;
        }
        
        .macro-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .macro-card.success {
            border-left-color: #28a745;
            background: linear-gradient(to right, rgba(40, 167, 69, 0.03) 0%, white 30%);
        }
        
        .macro-card.warning {
            border-left-color: #ffc107;
            background: linear-gradient(to right, rgba(255, 193, 7, 0.03) 0%, white 30%);
        }
        
        .macro-card.danger {
            border-left-color: #dc3545;
            background: linear-gradient(to right, rgba(220, 53, 69, 0.03) 0%, white 30%);
        }
        
        .macro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .macro-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #333;
            flex: 1;
        }
        
        .macro-count {
            font-size: 0.85em;
            color: #6c757d;
            font-weight: 500;
            margin-left: 8px;
        }
        
        .macro-percentage {
            font-size: 1.8em;
            font-weight: 700;
            padding: 8px 16px;
            border-radius: 25px;
            background: #f8f9fa;
            min-width: 80px;
            text-align: center;
        }
        
        .macro-percentage.success {
            color: #28a745;
            background: #d4edda;
        }
        
        .macro-percentage.warning {
            color: #856404;
            background: #fff3cd;
        }
        
        .macro-percentage.danger {
            color: #721c24;
            background: #f8d7da;
        }
        
        .macro-progress {
            height: 10px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .macro-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
        }
        
        .macro-progress-bar.success {
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        }
        
        .macro-progress-bar.warning {
            background: linear-gradient(90deg, #ffc107 0%, #ff8c00 100%);
        }
        
        .macro-progress-bar.danger {
            background: linear-gradient(90deg, #dc3545 0%, #c82333 100%);
        }
        
        .macro-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #495057;
        }
        
        .macro-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* MENSAGENS DE ALERTA */
        .macro-alert {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85em;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .macro-alert.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 3px solid #ffc107;
        }
        
        .macro-alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 3px solid #17a2b8;
        }
        
        .macro-projects {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
        }
        
        .macro-projects-label {
            font-size: 0.85em;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 8px;
        }
        
        .macro-project-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .project-badge {
            display: inline-block;
            padding: 5px 14px;
            background: #e9ecef;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .project-badge:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        /* CARDS PROJETOS (VIS√ÉO POR PROJETO) */
        .project-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .project-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid #007bff;
            cursor: pointer;
        }
        
        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .project-card.concluido {
            border-left-color: #28a745;
        }
        
        .project-card.andamento {
            border-left-color: #ffc107;
        }
        
        .project-card.atrasado {
            border-left-color: #dc3545;
        }
        
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .project-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
        }
        
        .project-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .project-status.concluido {
            background: #d4edda;
            color: #155724;
        }
        
        .project-status.andamento {
            background: #fff3cd;
            color: #856404;
        }
        
        .project-status.atrasado {
            background: #f8d7da;
            color: #721c24;
        }
        
        .project-info {
            margin-bottom: 15px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .info-label {
            color: #6c757d;
            font-weight: 500;
        }
        
        .info-value {
            color: #333;
            font-weight: 600;
        }
        
        /* FASE ATUAL NO CARD DO PROJETO */
        .project-current-phase {
            background: #e7f3ff;
            border-left: 3px solid #2196F3;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        
        .project-current-phase strong {
            color: #1976D2;
        }
        
        .phase-progress {
            color: #666;
            font-size: 0.85em;
            margin-top: 4px;
        }
        
        .progress-section {
            margin-top: 15px;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .progress-bar-container {
            height: 12px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
        }
        
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .no-data h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        /* Bot√£o voltar admin */
        .back-btn {
            display: inline-block;
            padding: 10px 20px;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
        }
        
        /* Responsivo */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .filters {
                grid-template-columns: 1fr;
            }
            
            .view-toggle {
                flex-direction: column;
            }
            
            .view-toggle button {
                width: 100%;
            }
            
            .macro-cards,
            .project-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Dashboard de Infraestrutura v7.2.1</h1>
            <p class="subtitle">Gest√£o de Projetos | Invent Corp</p>
            <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin-top: 15px; font-size: 0.9em; display: flex; align-items: center; justify-content: space-between;">
                <span>üí° <strong>Dados de teste carregados!</strong> Use Admin ‚Üí Upload Excel para carregar seus dados reais.</span>
                <button onclick="recarregarDadosTeste()" style="background: rgba(255,255,255,0.3); border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 600; margin-left: 15px;">üîÑ Recarregar Dados Teste</button>
            </div>
            <a href="admin.html" class="back-btn">‚öôÔ∏è Administra√ß√£o</a>
        </div>
        
        <div class="controls">
            <!-- TOGGLE VIS√ÉO EXECUTIVA/PROJETO -->
            <div class="view-toggle">
                <button id="btnExecutiva" class="active" onclick="changeView('executiva')">
                    üéØ Vis√£o Executiva (Macro)
                </button>
                <button id="btnProjeto" onclick="changeView('projeto')">
                    üìã Vis√£o por Projeto (Micro)
                </button>
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label>üîç Buscar Projeto:</label>
                    <input type="text" id="filterSearch" placeholder="Digite o nome do projeto..." onkeyup="applyFilters()">
                </div>
                
                <div class="filter-group">
                    <label>üìä Status:</label>
                    <select id="filterStatus" onchange="applyFilters()">
                        <option value="">Todos os Status</option>
                        <option value="Planejamento">Planejamento</option>
                        <option value="Em andamento">Em andamento</option>
                        <option value="Conclu√≠do">Conclu√≠do</option>
                        <option value="Pausado">Pausado</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>üìç Localiza√ß√£o:</label>
                    <select id="filterLocation" onchange="applyFilters()">
                        <option value="">Todas as Localiza√ß√µes</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>üë§ Respons√°vel:</label>
                    <select id="filterResponsible" onchange="applyFilters()">
                        <option value="">Todos os Respons√°veis</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="content">
            <!-- Container para Vis√£o Executiva -->
            <div id="viewExecutiva" style="display: block;">
                <div id="macroCardsContainer"></div>
            </div>
            
            <!-- Container para Vis√£o por Projeto -->
            <div id="viewProjeto" style="display: none;">
                <div id="projectCardsContainer"></div>
            </div>
        </div>
    </div>
    
    <script>
        let projectsData = [];
        let activitiesData = [];
        let currentView = 'executiva';
        
        // Carregar dados do localStorage
        // Recarregar dados de teste (limpa localStorage e carrega novamente)
        function recarregarDadosTeste() {
            if (confirm('Tem certeza? Isso vai remover todos os dados atuais e recarregar os dados de teste.')) {
                localStorage.removeItem('projectsData');
                localStorage.removeItem('activitiesData');
                loadSampleData();
                populateFilters();
                renderCurrentView();
                alert('‚úÖ Dados de teste recarregados com sucesso!');
            }
        }
        
        function loadData() {
            const storedProjects = localStorage.getItem('projectsData');
            const storedActivities = localStorage.getItem('activitiesData');
            
            // Se n√£o houver dados, carrega dados fict√≠cios para teste
            if (!storedProjects || !storedActivities) {
                loadSampleData();
            } else {
                projectsData = JSON.parse(storedProjects);
                activitiesData = JSON.parse(storedActivities);
            }
            
            populateFilters();
            renderCurrentView();
        }
        
        // Carregar dados fict√≠cios para teste (v7.2.1)
        function loadSampleData() {
            // Projetos de exemplo
            projectsData = [
                {
                    projeto: 'COUGAR',
                    status: 'Em andamento',
                    dataInicio: '01/12/2024',
                    dataPrevista: '28/02/2025',
                    responsavel: 'Daia',
                    localizacao: 'S√£o Paulo - SP'
                },
                {
                    projeto: 'BETA',
                    status: 'Atrasado',
                    dataInicio: '15/11/2024',
                    dataPrevista: '31/03/2025',
                    responsavel: 'Daia',
                    localizacao: 'Rio de Janeiro - RJ'
                },
                {
                    projeto: 'NAVEPARK',
                    status: 'Conclu√≠do',
                    dataInicio: '01/09/2024',
                    dataPrevista: '20/01/2025',
                    responsavel: 'Daia',
                    localizacao: 'Curitiba - PR'
                }
            ];
            
            // Atividades de exemplo (20 atividades padr√£o por projeto)
            const atividadesPadrao = [
                { ordem: 1, nome: 'KICKOFF INTERNO', macroEtapa: '1. Inicia√ß√£o' },
                { ordem: 2, nome: 'Definir escopo e objetivos', macroEtapa: '1. Inicia√ß√£o' },
                { ordem: 3, nome: 'Identificar stakeholders', macroEtapa: '1. Inicia√ß√£o' },
                { ordem: 4, nome: 'Criar cronograma inicial', macroEtapa: '2. Planejamento & Documenta√ß√£o' },
                { ordem: 5, nome: 'Elaborar documenta√ß√£o t√©cnica', macroEtapa: '2. Planejamento & Documenta√ß√£o' },
                { ordem: 6, nome: 'Revisar or√ßamento', macroEtapa: '2. Planejamento & Documenta√ß√£o' },
                { ordem: 7, nome: 'Solicitar recursos t√©cnicos', macroEtapa: '3. Provisionamento de Recursos' },
                { ordem: 8, nome: 'Aprovar aquisi√ß√µes', macroEtapa: '3. Provisionamento de Recursos' },
                { ordem: 9, nome: 'Alocar equipe', macroEtapa: '3. Provisionamento de Recursos' },
                { ordem: 10, nome: 'Configurar infraestrutura', macroEtapa: '4. Implementa√ß√£o' },
                { ordem: 11, nome: 'Desenvolver solu√ß√£o', macroEtapa: '4. Implementa√ß√£o' },
                { ordem: 12, nome: 'Integrar sistemas', macroEtapa: '4. Implementa√ß√£o' },
                { ordem: 13, nome: 'Documentar implementa√ß√£o', macroEtapa: '4. Implementa√ß√£o' },
                { ordem: 14, nome: 'Executar testes unit√°rios', macroEtapa: '5. Testes & Homologa√ß√£o' },
                { ordem: 15, nome: 'Realizar homologa√ß√£o', macroEtapa: '5. Testes & Homologa√ß√£o' },
                { ordem: 16, nome: 'Validar com usu√°rios', macroEtapa: '5. Testes & Homologa√ß√£o' },
                { ordem: 17, nome: 'Deploy em produ√ß√£o', macroEtapa: '6. Deploy em Produ√ß√£o' },
                { ordem: 18, nome: 'Monitorar estabilidade', macroEtapa: '7. Estabiliza√ß√£o' },
                { ordem: 19, nome: 'Treinar usu√°rios finais', macroEtapa: '7. Estabiliza√ß√£o' },
                { ordem: 20, nome: 'Encerrar projeto e documentar li√ß√µes', macroEtapa: '8. Encerramento' }
            ];
            
            activitiesData = [];
            
            // COUGAR - 35% conclu√≠do (7 de 20 atividades) - Fase atual: Testes
            atividadesPadrao.forEach((ativ, index) => {
                let status = 'Aguardando';
                if (index < 7) status = 'Conclu√≠do'; // Atividades 1-7 conclu√≠das (at√© Provisionamento)
                else if (index >= 13 && index < 16) status = 'Aguardando'; // Testes aguardando
                
                activitiesData.push({
                    projeto: 'COUGAR',
                    atividade: ativ.nome,
                    macroEtapa: ativ.macroEtapa,
                    status: status,
                    dataInicio: index < 7 ? '01/12/2024' : '',
                    dataConclusao: index < 7 ? '15/12/2024' : ''
                });
            });
            
            // BETA - 10% conclu√≠do (2 de 20 atividades) - Fase atual: Provisionamento
            atividadesPadrao.forEach((ativ, index) => {
                let status = 'Aguardando';
                if (index < 2) status = 'Conclu√≠do'; // Atividades 1-2 conclu√≠das (Inicia√ß√£o parcial)
                else if (index >= 6 && index < 9) status = 'Aguardando'; // Provisionamento aguardando
                
                activitiesData.push({
                    projeto: 'BETA',
                    atividade: ativ.nome,
                    macroEtapa: ativ.macroEtapa,
                    status: status,
                    dataInicio: index < 2 ? '15/11/2024' : '',
                    dataConclusao: index < 2 ? '30/11/2024' : ''
                });
            });
            
            // NAVEPARK - 100% conclu√≠do (20 de 20 atividades) - Fase atual: Encerramento
            atividadesPadrao.forEach((ativ, index) => {
                activitiesData.push({
                    projeto: 'NAVEPARK',
                    atividade: ativ.nome,
                    macroEtapa: ativ.macroEtapa,
                    status: 'Conclu√≠do',
                    dataInicio: '01/09/2024',
                    dataConclusao: '20/01/2025'
                });
            });
            
            // Salvar no localStorage
            localStorage.setItem('projectsData', JSON.stringify(projectsData));
            localStorage.setItem('activitiesData', JSON.stringify(activitiesData));
            
            console.log('‚úÖ Dados fict√≠cios carregados para teste (v7.2.1)');
            console.log('Projetos:', projectsData.length);
            console.log('Atividades:', activitiesData.length);
        }
        
        // Alternar entre vis√µes
        function changeView(view) {
            currentView = view;
            
            // Atualizar bot√µes
            document.getElementById('btnExecutiva').classList.toggle('active', view === 'executiva');
            document.getElementById('btnProjeto').classList.toggle('active', view === 'projeto');
            
            // Atualizar containers
            document.getElementById('viewExecutiva').style.display = view === 'executiva' ? 'block' : 'none';
            document.getElementById('viewProjeto').style.display = view === 'projeto' ? 'block' : 'none';
            
            renderCurrentView();
        }
        
        // Renderizar vis√£o atual
        function renderCurrentView() {
            if (currentView === 'executiva') {
                renderVisaoExecutiva();
            } else {
                renderVisaoPorProjeto();
            }
        }
        
        // Determinar cor baseada em percentual
        function getColorClass(percentage) {
            if (percentage >= 80) return 'success';
            if (percentage >= 40) return 'warning';
            return 'danger';
        }
        
        // Calcular fase atual de um projeto
        function calcularFaseAtual(projeto) {
            const atividadesProjeto = activitiesData.filter(a => 
                a.projeto.trim() === projeto.trim() && a.macroEtapa
            );
            
            if (atividadesProjeto.length === 0) return null;
            
            // Ordenar por n√∫mero da macro (1, 2, 3...)
            const macrosOrdenadas = [
                '1. Inicia√ß√£o',
                '2. Planejamento & Documenta√ß√£o',
                '3. Provisionamento de Recursos',
                '4. Implementa√ß√£o',
                '5. Testes & Homologa√ß√£o',
                '6. Deploy em Produ√ß√£o',
                '7. Estabiliza√ß√£o',
                '8. Encerramento'
            ];
            
            // Verificar se projeto est√° 100% conclu√≠do
            const todasConcluidas = atividadesProjeto.every(a => a.status === 'Conclu√≠do');
            if (todasConcluidas) {
                // Projeto 100% ‚Üí √öltima fase com atividades
                for (let i = macrosOrdenadas.length - 1; i >= 0; i--) {
                    const macro = macrosOrdenadas[i];
                    const atividadesFase = atividadesProjeto.filter(a => a.macroEtapa === macro);
                    
                    if (atividadesFase.length > 0) {
                        return {
                            nome: macro,
                            percentual: 100
                        };
                    }
                }
            }
            
            // Encontrar √∫ltima fase com atividades em andamento ou iniciadas
            for (let i = macrosOrdenadas.length - 1; i >= 0; i--) {
                const macro = macrosOrdenadas[i];
                const atividadesFase = atividadesProjeto.filter(a => a.macroEtapa === macro);
                
                if (atividadesFase.length > 0) {
                    const emAndamento = atividadesFase.some(a => 
                        a.status === 'Em andamento' || a.status === 'Aguardando'
                    );
                    const concluidas = atividadesFase.filter(a => a.status === 'Conclu√≠do').length;
                    const total = atividadesFase.length;
                    const percentualFase = Math.round((concluidas / total) * 100);
                    
                    if (emAndamento || percentualFase > 0) {
                        return {
                            nome: macro,
                            percentual: percentualFase
                        };
                    }
                }
            }
            
            return null;
        }
        
        // VIS√ÉO EXECUTIVA - Agrupa projetos por Fase Atual (CORRIGIDO v7.2)
        function renderVisaoExecutiva() {
            const container = document.getElementById('macroCardsContainer');
            
            // Filtrar projetos
            const filteredProjects = applyProjectFilters(projectsData);
            
            if (filteredProjects.length === 0) {
                container.innerHTML = '<div class="no-data"><h3>Nenhum projeto encontrado</h3><p>Ajuste os filtros ou carregue novos dados.</p></div>';
                return;
            }
            
            // Macro etapas dispon√≠veis
            const macroEtapas = [
                '1. Inicia√ß√£o',
                '2. Planejamento & Documenta√ß√£o',
                '3. Provisionamento de Recursos',
                '4. Implementa√ß√£o',
                '5. Testes & Homologa√ß√£o',
                '6. Deploy em Produ√ß√£o',
                '7. Estabiliza√ß√£o',
                '8. Encerramento'
            ];
            
            // Agrupar projetos por FASE ATUAL (cada projeto em apenas UMA fase)
            const projetosPorFase = {};
            
            filteredProjects.forEach(project => {
                const faseAtual = calcularFaseAtual(project.projeto);
                
                if (faseAtual && faseAtual.nome) {
                    if (!projetosPorFase[faseAtual.nome]) {
                        projetosPorFase[faseAtual.nome] = [];
                    }
                    
                    projetosPorFase[faseAtual.nome].push({
                        nome: project.projeto,
                        percentualFase: faseAtual.percentual
                    });
                }
            });
            
            let html = '';
            
            // Renderizar cada macro etapa
            macroEtapas.forEach(macro => {
                const projetosFase = projetosPorFase[macro];
                
                if (!projetosFase || projetosFase.length === 0) return; // Pula fase sem projetos
                
                const numProjetos = projetosFase.length;
                
                // Calcular percentual m√©dio da fase (m√©dia dos percentuais de cada projeto)
                const percentualMedio = Math.round(
                    projetosFase.reduce((sum, p) => sum + p.percentualFase, 0) / numProjetos
                );
                
                // Contar atividades da fase de todos os projetos
                let totalAtividades = 0;
                let atividadesConcluidas = 0;
                
                projetosFase.forEach(proj => {
                    const atividadesFase = activitiesData.filter(a => 
                        a.projeto.trim() === proj.nome.trim() && a.macroEtapa === macro
                    );
                    totalAtividades += atividadesFase.length;
                    atividadesConcluidas += atividadesFase.filter(a => a.status === 'Conclu√≠do').length;
                });
                
                // Definir cor do card baseado no percentual m√©dio
                const colorClass = getColorClass(percentualMedio);
                
                // Mensagem de alerta contextual (v7.2.1 - CORRIGIDO)
                let alertaHtml = '';
                if (percentualMedio === 0) {
                    // Verifica se os projetos t√™m progresso geral ou se realmente est√£o parados
                    const projetosComProgresso = projetosFase.filter(p => {
                        const proj = filteredProjects.find(fp => fp.nome === p.nome || fp.projeto === p.nome);
                        if (!proj) return false;
                        
                        const atividadesProj = activitiesData.filter(a => a.projeto.trim() === p.nome.trim());
                        const concluidas = atividadesProj.filter(a => a.status === 'Conclu√≠do').length;
                        return concluidas > 0;
                    });
                    
                    if (projetosComProgresso.length > 0) {
                        alertaHtml = '<div class="macro-alert info">üìå Atividades desta fase ainda n√£o iniciadas</div>';
                    } else {
                        alertaHtml = '<div class="macro-alert info">‚è≥ Aguardando in√≠cio em todos os projetos</div>';
                    }
                } else if (percentualMedio < 40) {
                    alertaHtml = '<div class="macro-alert warning">‚ö†Ô∏è Fase com baixa execu√ß√£o no portf√≥lio</div>';
                }
                
                html += `
                    <div class="macro-card ${colorClass}">
                        <div class="macro-header">
                            <div style="flex: 1;">
                                <div class="macro-title">
                                    ${macro}
                                    <span class="macro-count">(${numProjetos} projeto${numProjetos !== 1 ? 's' : ''})</span>
                                </div>
                            </div>
                            <div class="macro-percentage ${colorClass}">${percentualMedio}%</div>
                        </div>
                        
                        <div class="macro-progress">
                            <div class="macro-progress-bar ${colorClass}" style="width: ${percentualMedio}%"></div>
                        </div>
                        
                        ${alertaHtml}
                        
                        <div class="macro-stats">
                            <div class="macro-stat">
                                <strong>${atividadesConcluidas}</strong>/${totalAtividades} atividades conclu√≠das
                            </div>
                        </div>
                        
                        <div class="macro-projects">
                            <div class="macro-projects-label">Projetos nesta fase:</div>
                            <div class="macro-project-badges">
                                ${projetosFase.map(p => 
                                    `<span class="project-badge" onclick="filterByProject('${p.nome}')" title="Clique para ver detalhes de ${p.nome}">${p.nome}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<div class="no-data"><h3>Nenhuma macro etapa com dados</h3><p>Os projetos filtrados n√£o possuem macro etapas definidas ainda.</p></div>';
            }
            
            container.innerHTML = html;
        }
        
        // Filtrar por projeto (quando clica no badge)
        function filterByProject(projeto) {
            document.getElementById('filterSearch').value = projeto;
            changeView('projeto');
            applyFilters();
        }
        
        // VIS√ÉO POR PROJETO - Cards de projetos (layout atual)
        function renderVisaoPorProjeto() {
            const container = document.getElementById('projectCardsContainer');
            
            // Filtrar projetos
            const filteredProjects = applyProjectFilters(projectsData);
            
            if (filteredProjects.length === 0) {
                container.innerHTML = '<div class="no-data"><h3>Nenhum projeto encontrado</h3><p>Ajuste os filtros ou carregue novos dados.</p></div>';
                return;
            }
            
            let html = '';
            
            filteredProjects.forEach(project => {
                // Calcular progresso
                const projectActivities = activitiesData.filter(a => a.projeto === project.projeto);
                const totalActivities = projectActivities.length;
                const completedActivities = projectActivities.filter(a => a.status === 'Conclu√≠do').length;
                const progress = totalActivities > 0 ? Math.round((completedActivities / totalActivities) * 100) : 0;
                
                // Determinar classe de status
                let statusClass = 'andamento';
                if (project.status === 'Conclu√≠do') statusClass = 'concluido';
                else if (progress < 30) statusClass = 'atrasado';
                
                // Calcular fase atual
                const faseAtual = calcularFaseAtual(project.projeto);
                let faseAtualHtml = '';
                if (faseAtual) {
                    faseAtualHtml = `
                        <div class="project-current-phase">
                            <strong>Fase atual:</strong> ${faseAtual.nome}
                            <div class="phase-progress">${faseAtual.percentual}% da fase conclu√≠do</div>
                        </div>
                    `;
                }
                
                html += `
                    <div class="project-card ${statusClass}" onclick="window.location.href='view-detalhada.html?projeto=${encodeURIComponent(project.projeto)}'">
                        <div class="project-header">
                            <div class="project-name">${project.projeto}</div>
                            <div class="project-status ${statusClass}">${project.status}</div>
                        </div>
                        
                        ${faseAtualHtml}
                        
                        <div class="project-info">
                            <div class="info-row">
                                <span class="info-label">üìÖ In√≠cio:</span>
                                <span class="info-value">${project.dataInicio || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üéØ Previs√£o:</span>
                                <span class="info-value">${project.dataPrevista || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üë§ Respons√°vel:</span>
                                <span class="info-value">${project.responsavel || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üìç Local:</span>
                                <span class="info-value">${project.localizacao || 'N/A'}</span>
                            </div>
                        </div>
                        
                        <div class="progress-section">
                            <div class="progress-label">
                                <span>Progresso Geral</span>
                                <span><strong>${progress}%</strong></span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Aplicar filtros nos projetos
        function applyProjectFilters(projects) {
            const searchText = document.getElementById('filterSearch').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const locationFilter = document.getElementById('filterLocation').value;
            const responsibleFilter = document.getElementById('filterResponsible').value;
            
            return projects.filter(project => {
                const matchSearch = project.projeto.toLowerCase().includes(searchText);
                const matchStatus = !statusFilter || project.status === statusFilter;
                const matchLocation = !locationFilter || project.localizacao === locationFilter;
                const matchResponsible = !responsibleFilter || project.responsavel === responsibleFilter;
                
                return matchSearch && matchStatus && matchLocation && matchResponsible;
            });
        }
        
        // Aplicar filtros (chamado quando usu√°rio muda filtros)
        function applyFilters() {
            renderCurrentView();
        }
        
        // Popular dropdowns de filtros
        function populateFilters() {
            // Localiza√ß√µes √∫nicas
            const locations = [...new Set(projectsData.map(p => p.localizacao))].filter(Boolean).sort();
            const locationSelect = document.getElementById('filterLocation');
            locationSelect.innerHTML = '<option value="">Todas as Localiza√ß√µes</option>' +
                locations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
            
            // Respons√°veis √∫nicos
            const responsibles = [...new Set(projectsData.map(p => p.responsavel))].filter(Boolean).sort();
            const responsibleSelect = document.getElementById('filterResponsible');
            responsibleSelect.innerHTML = '<option value="">Todos os Respons√°veis</option>' +
                responsibles.map(resp => `<option value="${resp}">${resp}</option>`).join('');
        }
        
        // Inicializar ao carregar p√°gina
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
