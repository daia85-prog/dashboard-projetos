<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Infraestrutura v7.1 - Vis√£o Macro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            opacity: 0.9;
            font-size: 0.95em;
        }
        
        .controls {
            padding: 25px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        /* TOGGLE VIS√ÉO EXECUTIVA/PROJETO */
        .view-toggle {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .view-toggle button {
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            border: 2px solid #667eea;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            color: #667eea;
        }
        
        .view-toggle button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }
        
        .view-toggle button:hover:not(.active) {
            background: #f0f0f0;
            transform: translateY(-2px);
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .filter-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.9em;
        }
        
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.95em;
            transition: border-color 0.3s;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .content {
            padding: 30px;
        }
        
        /* CARDS VIS√ÉO EXECUTIVA */
        .macro-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .macro-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid #667eea;
        }
        
        .macro-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .macro-card.success {
            border-left-color: #28a745;
            background: linear-gradient(to right, rgba(40, 167, 69, 0.03) 0%, white 30%);
        }
        
        .macro-card.warning {
            border-left-color: #ffc107;
            background: linear-gradient(to right, rgba(255, 193, 7, 0.03) 0%, white 30%);
        }
        
        .macro-card.danger {
            border-left-color: #dc3545;
            background: linear-gradient(to right, rgba(220, 53, 69, 0.03) 0%, white 30%);
        }
        
        .macro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .macro-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #333;
            flex: 1;
        }
        
        .macro-count {
            font-size: 0.85em;
            color: #6c757d;
            font-weight: 500;
            margin-left: 8px;
        }
        
        .macro-percentage {
            font-size: 1.8em;
            font-weight: 700;
            padding: 8px 16px;
            border-radius: 25px;
            background: #f8f9fa;
            min-width: 80px;
            text-align: center;
        }
        
        .macro-percentage.success {
            color: #28a745;
            background: #d4edda;
        }
        
        .macro-percentage.warning {
            color: #856404;
            background: #fff3cd;
        }
        
        .macro-percentage.danger {
            color: #721c24;
            background: #f8d7da;
        }
        
        .macro-progress {
            height: 10px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .macro-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
        }
        
        .macro-progress-bar.success {
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        }
        
        .macro-progress-bar.warning {
            background: linear-gradient(90deg, #ffc107 0%, #ff8c00 100%);
        }
        
        .macro-progress-bar.danger {
            background: linear-gradient(90deg, #dc3545 0%, #c82333 100%);
        }
        
        .macro-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #495057;
        }
        
        .macro-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* MENSAGENS DE ALERTA */
        .macro-alert {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85em;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .macro-alert.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 3px solid #ffc107;
        }
        
        .macro-alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 3px solid #17a2b8;
        }
        
        .macro-projects {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
        }
        
        .macro-projects-label {
            font-size: 0.85em;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 8px;
        }
        
        .macro-project-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .project-badge {
            display: inline-block;
            padding: 5px 14px;
            background: #e9ecef;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .project-badge:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        /* CARDS PROJETOS (VIS√ÉO POR PROJETO) */
        .project-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .project-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid #007bff;
            cursor: pointer;
        }
        
        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .project-card.concluido {
            border-left-color: #28a745;
        }
        
        .project-card.andamento {
            border-left-color: #ffc107;
        }
        
        .project-card.atrasado {
            border-left-color: #dc3545;
        }
        
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .project-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
        }
        
        .project-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .project-status.concluido {
            background: #d4edda;
            color: #155724;
        }
        
        .project-status.andamento {
            background: #fff3cd;
            color: #856404;
        }
        
        .project-status.atrasado {
            background: #f8d7da;
            color: #721c24;
        }
        
        .project-info {
            margin-bottom: 15px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .info-label {
            color: #6c757d;
            font-weight: 500;
        }
        
        .info-value {
            color: #333;
            font-weight: 600;
        }
        
        /* FASE ATUAL NO CARD DO PROJETO */
        .project-current-phase {
            background: #e7f3ff;
            border-left: 3px solid #2196F3;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        
        .project-current-phase strong {
            color: #1976D2;
        }
        
        .phase-progress {
            color: #666;
            font-size: 0.85em;
            margin-top: 4px;
        }
        
        .progress-section {
            margin-top: 15px;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .progress-bar-container {
            height: 12px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
        }
        
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .no-data h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        /* Bot√£o voltar admin */
        .back-btn {
            display: inline-block;
            padding: 10px 20px;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
        }
        
        /* Responsivo */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .filters {
                grid-template-columns: 1fr;
            }
            
            .view-toggle {
                flex-direction: column;
            }
            
            .view-toggle button {
                width: 100%;
            }
            
            .macro-cards,
            .project-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Dashboard de Infraestrutura v7.1</h1>
            <p class="subtitle">Gest√£o de Projetos | Invent Corp</p>
            <a href="admin.html" class="back-btn">‚öôÔ∏è Administra√ß√£o</a>
        </div>
        
        <div class="controls">
            <!-- TOGGLE VIS√ÉO EXECUTIVA/PROJETO -->
            <div class="view-toggle">
                <button id="btnExecutiva" class="active" onclick="changeView('executiva')">
                    üéØ Vis√£o Executiva (Macro)
                </button>
                <button id="btnProjeto" onclick="changeView('projeto')">
                    üìã Vis√£o por Projeto (Micro)
                </button>
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label>üîç Buscar Projeto:</label>
                    <input type="text" id="filterSearch" placeholder="Digite o nome do projeto..." onkeyup="applyFilters()">
                </div>
                
                <div class="filter-group">
                    <label>üìä Status:</label>
                    <select id="filterStatus" onchange="applyFilters()">
                        <option value="">Todos os Status</option>
                        <option value="Planejamento">Planejamento</option>
                        <option value="Em andamento">Em andamento</option>
                        <option value="Conclu√≠do">Conclu√≠do</option>
                        <option value="Pausado">Pausado</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>üìç Localiza√ß√£o:</label>
                    <select id="filterLocation" onchange="applyFilters()">
                        <option value="">Todas as Localiza√ß√µes</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>üë§ Respons√°vel:</label>
                    <select id="filterResponsible" onchange="applyFilters()">
                        <option value="">Todos os Respons√°veis</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="content">
            <!-- Container para Vis√£o Executiva -->
            <div id="viewExecutiva" style="display: block;">
                <div id="macroCardsContainer"></div>
            </div>
            
            <!-- Container para Vis√£o por Projeto -->
            <div id="viewProjeto" style="display: none;">
                <div id="projectCardsContainer"></div>
            </div>
        </div>
    </div>
    
    <script>
        let projectsData = [];
        let activitiesData = [];
        let currentView = 'executiva';
        
        // Carregar dados do localStorage
        function loadData() {
            const storedProjects = localStorage.getItem('projectsData');
            const storedActivities = localStorage.getItem('activitiesData');
            
            if (storedProjects) {
                projectsData = JSON.parse(storedProjects);
            }
            
            if (storedActivities) {
                activitiesData = JSON.parse(storedActivities);
            }
            
            populateFilters();
            renderCurrentView();
        }
        
        // Alternar entre vis√µes
        function changeView(view) {
            currentView = view;
            
            // Atualizar bot√µes
            document.getElementById('btnExecutiva').classList.toggle('active', view === 'executiva');
            document.getElementById('btnProjeto').classList.toggle('active', view === 'projeto');
            
            // Atualizar containers
            document.getElementById('viewExecutiva').style.display = view === 'executiva' ? 'block' : 'none';
            document.getElementById('viewProjeto').style.display = view === 'projeto' ? 'block' : 'none';
            
            renderCurrentView();
        }
        
        // Renderizar vis√£o atual
        function renderCurrentView() {
            if (currentView === 'executiva') {
                renderVisaoExecutiva();
            } else {
                renderVisaoPorProjeto();
            }
        }
        
        // Determinar cor baseada em percentual
        function getColorClass(percentage) {
            if (percentage >= 80) return 'success';
            if (percentage >= 40) return 'warning';
            return 'danger';
        }
        
        // Calcular fase atual de um projeto
        function calcularFaseAtual(projeto) {
            const atividadesProjeto = activitiesData.filter(a => 
                a.projeto.trim() === projeto.trim() && a.macroEtapa
            );
            
            if (atividadesProjeto.length === 0) return null;
            
            // Ordenar por n√∫mero da macro (1, 2, 3...)
            const macrosOrdenadas = [
                '1. Inicia√ß√£o',
                '2. Planejamento & Documenta√ß√£o',
                '3. Provisionamento de Recursos',
                '4. Implementa√ß√£o',
                '5. Testes & Homologa√ß√£o',
                '6. Deploy em Produ√ß√£o',
                '7. Estabiliza√ß√£o',
                '8. Encerramento'
            ];
            
            // Encontrar √∫ltima fase com atividades em andamento ou conclu√≠das
            for (let i = macrosOrdenadas.length - 1; i >= 0; i--) {
                const macro = macrosOrdenadas[i];
                const atividadesFase = atividadesProjeto.filter(a => a.macroEtapa === macro);
                
                if (atividadesFase.length > 0) {
                    const emAndamento = atividadesFase.some(a => 
                        a.status === 'Em andamento' || a.status === 'Aguardando'
                    );
                    const concluidas = atividadesFase.filter(a => a.status === 'Conclu√≠do').length;
                    const total = atividadesFase.length;
                    const percentualFase = Math.round((concluidas / total) * 100);
                    
                    if (emAndamento || percentualFase > 0) {
                        return {
                            nome: macro,
                            percentual: percentualFase
                        };
                    }
                }
            }
            
            return null;
        }
        
        // VIS√ÉO EXECUTIVA - Agrupa por Macro Etapa
        function renderVisaoExecutiva() {
            const container = document.getElementById('macroCardsContainer');
            
            // Filtrar projetos
            const filteredProjects = applyProjectFilters(projectsData);
            
            if (filteredProjects.length === 0) {
                container.innerHTML = '<div class="no-data"><h3>Nenhum projeto encontrado</h3><p>Ajuste os filtros ou carregue novos dados.</p></div>';
                return;
            }
            
            // Agrupar atividades por macro etapa
            const macroEtapas = [
                '1. Inicia√ß√£o',
                '2. Planejamento & Documenta√ß√£o',
                '3. Provisionamento de Recursos',
                '4. Implementa√ß√£o',
                '5. Testes & Homologa√ß√£o',
                '6. Deploy em Produ√ß√£o',
                '7. Estabiliza√ß√£o',
                '8. Encerramento'
            ];
            
            let html = '';
            
            macroEtapas.forEach(macro => {
                // Filtrar atividades desta macro dos projetos filtrados
                const atividadesMacro = activitiesData.filter(a => {
                    const projeto = a.projeto.trim();
                    return a.macroEtapa === macro && 
                           filteredProjects.some(p => p.projeto.trim() === projeto);
                });
                
                if (atividadesMacro.length === 0) return; // Pula macro sem atividades
                
                // Calcular estat√≠sticas
                const total = atividadesMacro.length;
                const concluidas = atividadesMacro.filter(a => a.status === 'Conclu√≠do').length;
                const percentage = Math.round((concluidas / total) * 100);
                
                // Definir cor do card
                const colorClass = getColorClass(percentage);
                
                // Projetos envolvidos (√∫nicos)
                const projetosUnicos = [...new Set(atividadesMacro.map(a => a.projeto))];
                const numProjetos = projetosUnicos.length;
                
                // Mensagem de alerta
                let alertaHtml = '';
                if (percentage === 0) {
                    alertaHtml = '<div class="macro-alert info">‚è≥ Aguardando in√≠cio em todos os projetos</div>';
                } else if (percentage < 40) {
                    alertaHtml = '<div class="macro-alert warning">‚ö†Ô∏è Fase com baixa execu√ß√£o no portf√≥lio</div>';
                }
                
                html += `
                    <div class="macro-card ${colorClass}">
                        <div class="macro-header">
                            <div style="flex: 1;">
                                <div class="macro-title">
                                    ${macro}
                                    <span class="macro-count">(${numProjetos} projeto${numProjetos !== 1 ? 's' : ''})</span>
                                </div>
                            </div>
                            <div class="macro-percentage ${colorClass}">${percentage}%</div>
                        </div>
                        
                        <div class="macro-progress">
                            <div class="macro-progress-bar ${colorClass}" style="width: ${percentage}%"></div>
                        </div>
                        
                        ${alertaHtml}
                        
                        <div class="macro-stats">
                            <div class="macro-stat">
                                <strong>${concluidas}</strong>/${total} atividades conclu√≠das
                            </div>
                        </div>
                        
                        <div class="macro-projects">
                            <div class="macro-projects-label">Projetos envolvidos:</div>
                            <div class="macro-project-badges">
                                ${projetosUnicos.map(p => 
                                    `<span class="project-badge" onclick="filterByProject('${p}')" title="Clique para ver detalhes de ${p}">${p}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<div class="no-data"><h3>Nenhuma macro etapa com dados</h3><p>Os projetos filtrados n√£o possuem macro etapas definidas ainda.</p></div>';
            }
            
            container.innerHTML = html;
        }
        
        // Filtrar por projeto (quando clica no badge)
        function filterByProject(projeto) {
            document.getElementById('filterSearch').value = projeto;
            changeView('projeto');
            applyFilters();
        }
        
        // VIS√ÉO POR PROJETO - Cards de projetos (layout atual)
        function renderVisaoPorProjeto() {
            const container = document.getElementById('projectCardsContainer');
            
            // Filtrar projetos
            const filteredProjects = applyProjectFilters(projectsData);
            
            if (filteredProjects.length === 0) {
                container.innerHTML = '<div class="no-data"><h3>Nenhum projeto encontrado</h3><p>Ajuste os filtros ou carregue novos dados.</p></div>';
                return;
            }
            
            let html = '';
            
            filteredProjects.forEach(project => {
                // Calcular progresso
                const projectActivities = activitiesData.filter(a => a.projeto === project.projeto);
                const totalActivities = projectActivities.length;
                const completedActivities = projectActivities.filter(a => a.status === 'Conclu√≠do').length;
                const progress = totalActivities > 0 ? Math.round((completedActivities / totalActivities) * 100) : 0;
                
                // Determinar classe de status
                let statusClass = 'andamento';
                if (project.status === 'Conclu√≠do') statusClass = 'concluido';
                else if (progress < 30) statusClass = 'atrasado';
                
                // Calcular fase atual
                const faseAtual = calcularFaseAtual(project.projeto);
                let faseAtualHtml = '';
                if (faseAtual) {
                    faseAtualHtml = `
                        <div class="project-current-phase">
                            <strong>Fase atual:</strong> ${faseAtual.nome}
                            <div class="phase-progress">${faseAtual.percentual}% da fase conclu√≠do</div>
                        </div>
                    `;
                }
                
                html += `
                    <div class="project-card ${statusClass}" onclick="window.location.href='view-detalhada.html?projeto=${encodeURIComponent(project.projeto)}'">
                        <div class="project-header">
                            <div class="project-name">${project.projeto}</div>
                            <div class="project-status ${statusClass}">${project.status}</div>
                        </div>
                        
                        ${faseAtualHtml}
                        
                        <div class="project-info">
                            <div class="info-row">
                                <span class="info-label">üìÖ In√≠cio:</span>
                                <span class="info-value">${project.dataInicio || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üéØ Previs√£o:</span>
                                <span class="info-value">${project.dataPrevista || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üë§ Respons√°vel:</span>
                                <span class="info-value">${project.responsavel || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üìç Local:</span>
                                <span class="info-value">${project.localizacao || 'N/A'}</span>
                            </div>
                        </div>
                        
                        <div class="progress-section">
                            <div class="progress-label">
                                <span>Progresso Geral</span>
                                <span><strong>${progress}%</strong></span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Aplicar filtros nos projetos
        function applyProjectFilters(projects) {
            const searchText = document.getElementById('filterSearch').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const locationFilter = document.getElementById('filterLocation').value;
            const responsibleFilter = document.getElementById('filterResponsible').value;
            
            return projects.filter(project => {
                const matchSearch = project.projeto.toLowerCase().includes(searchText);
                const matchStatus = !statusFilter || project.status === statusFilter;
                const matchLocation = !locationFilter || project.localizacao === locationFilter;
                const matchResponsible = !responsibleFilter || project.responsavel === responsibleFilter;
                
                return matchSearch && matchStatus && matchLocation && matchResponsible;
            });
        }
        
        // Aplicar filtros (chamado quando usu√°rio muda filtros)
        function applyFilters() {
            renderCurrentView();
        }
        
        // Popular dropdowns de filtros
        function populateFilters() {
            // Localiza√ß√µes √∫nicas
            const locations = [...new Set(projectsData.map(p => p.localizacao))].filter(Boolean).sort();
            const locationSelect = document.getElementById('filterLocation');
            locationSelect.innerHTML = '<option value="">Todas as Localiza√ß√µes</option>' +
                locations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
            
            // Respons√°veis √∫nicos
            const responsibles = [...new Set(projectsData.map(p => p.responsavel))].filter(Boolean).sort();
            const responsibleSelect = document.getElementById('filterResponsible');
            responsibleSelect.innerHTML = '<option value="">Todos os Respons√°veis</option>' +
                responsibles.map(resp => `<option value="${resp}">${resp}</option>`).join('');
        }
        
        // Inicializar ao carregar p√°gina
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
