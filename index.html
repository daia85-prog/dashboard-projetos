<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Infraestrutura v7.3.1</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 25px; text-align: center; }
        .header h1 { font-size: 1.5em; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 0.85em; }
        
        .nav { background: #f8fafc; padding: 15px; display: flex; justify-content: center; gap: 10px; border-bottom: 1px solid #e2e8f0; }
        .nav a { padding: 10px 20px; background: #6b7280; color: white; text-decoration: none; border-radius: 8px; font-weight: 500; font-size: 0.9em; }
        .nav a:hover { background: #4b5563; }
        
        .content { padding: 25px; }
        
        .toggle { display: flex; justify-content: center; margin-bottom: 20px; }
        .toggle button { padding: 12px 30px; border: 2px solid #667eea; background: white; color: #667eea; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .toggle button:first-child { border-radius: 25px 0 0 25px; }
        .toggle button:last-child { border-radius: 0 25px 25px 0; border-left: none; }
        .toggle button.active { background: #667eea; color: white; }
        
        .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 10px; }
        .filter-group label { display: block; font-size: 0.8em; color: #64748b; margin-bottom: 4px; }
        .filter-group input, .filter-group select { width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9em; }
        
        /* Fase cards (Macro) */
        .phases { display: flex; flex-direction: column; gap: 15px; }
        .phase-card { border-left: 4px solid #e2e8f0; padding: 15px 20px; background: #f8fafc; border-radius: 0 10px 10px 0; }
        .phase-card.verde { border-left-color: #22c55e; }
        .phase-card.amarelo { border-left-color: #f59e0b; }
        .phase-card.vermelho { border-left-color: #ef4444; }
        
        .phase-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .phase-title { font-weight: 700; color: #1e293b; }
        .phase-count { font-size: 0.85em; color: #64748b; }
        .phase-percent { font-size: 1.3em; font-weight: 700; }
        .phase-percent.verde { color: #22c55e; }
        .phase-percent.amarelo { color: #f59e0b; }
        .phase-percent.vermelho { color: #ef4444; }
        
        .phase-bar { height: 8px; background: #e2e8f0; border-radius: 4px; margin-bottom: 10px; overflow: hidden; }
        .phase-bar-fill { height: 100%; border-radius: 4px; }
        .phase-bar-fill.verde { background: #22c55e; }
        .phase-bar-fill.amarelo { background: #f59e0b; }
        .phase-bar-fill.vermelho { background: #ef4444; }
        
        .phase-info { font-size: 0.85em; color: #64748b; margin-bottom: 8px; }
        .phase-projects { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
        .phase-projects span { font-size: 0.85em; color: #64748b; }
        .badge { background: #e0e7ff; color: #4338ca; padding: 5px 12px; border-radius: 15px; font-size: 0.8em; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .badge:hover { background: #4338ca; color: white; }
        
        /* Project cards (Micro) */
        .projects { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .project-card { background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.2s; border-left: 4px solid #e2e8f0; }
        .project-card:hover { box-shadow: 0 5px 20px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .project-card.verde { border-left-color: #22c55e; }
        .project-card.amarelo { border-left-color: #f59e0b; }
        .project-card.vermelho { border-left-color: #ef4444; }
        
        .project-name { font-weight: 700; color: #1e293b; margin-bottom: 8px; font-size: 1.1em; }
        .project-meta { display: flex; gap: 15px; font-size: 0.85em; color: #64748b; margin-bottom: 10px; }
        .project-phase { background: #eff6ff; color: #1d4ed8; padding: 6px 10px; border-radius: 6px; font-size: 0.8em; margin-bottom: 10px; }
        
        .progress { margin-bottom: 8px; }
        .progress-header { display: flex; justify-content: space-between; font-size: 0.85em; margin-bottom: 4px; }
        .progress-bar { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 3px; }
        .progress-fill.verde { background: #22c55e; }
        .progress-fill.amarelo { background: #f59e0b; }
        .progress-fill.vermelho { background: #ef4444; }
        
        .status-badge { display: inline-block; padding: 3px 10px; border-radius: 5px; font-size: 0.75em; font-weight: 600; }
        .status-badge.concluido { background: #dcfce7; color: #166534; }
        .status-badge.em-andamento { background: #dbeafe; color: #1e40af; }
        .status-badge.aguardando { background: #fef3c7; color: #92400e; }
        .status-badge.nao-iniciado { background: #f3f4f6; color: #4b5563; }
        
        .empty { text-align: center; padding: 40px; color: #64748b; }
        
        /* Modal */
        .modal-bg { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal-bg.show { display: flex; }
        .modal { background: white; border-radius: 12px; max-width: 700px; width: 100%; max-height: 85vh; overflow: hidden; }
        .modal-head { background: #667eea; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-head h2 { font-size: 1.1em; }
        .modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 1.2em; }
        .modal-body { padding: 20px; max-height: calc(85vh - 60px); overflow-y: auto; }
        
        .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .summary-item { text-align: center; padding: 10px; background: #f8fafc; border-radius: 8px; }
        .summary-item .num { font-size: 1.4em; font-weight: 700; }
        .summary-item .lbl { font-size: 0.75em; color: #64748b; }
        
        .activity-list { border: 1px solid #e2e8f0; border-radius: 8px; }
        .activity { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-bottom: 1px solid #e2e8f0; }
        .activity:last-child { border-bottom: none; }
        .activity:nth-child(even) { background: #f8fafc; }
        .activity-name { font-size: 0.9em; color: #1e293b; }
        .activity-fase { font-size: 0.75em; color: #64748b; }
        
        .timestamp { text-align: center; padding: 15px; color: #94a3b8; font-size: 0.8em; border-top: 1px solid #e2e8f0; margin-top: 20px; }
        
        @media (max-width: 600px) {
            .filters { grid-template-columns: 1fr; }
            .projects { grid-template-columns: 1fr; }
            .summary { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üìä Dashboard de Infraestrutura v7.3.1</h1>
            <p>Gest√£o de Projetos | Invent Corp</p>
        </header>
        
        <nav class="nav">
            <a href="admin.html">‚öôÔ∏è Administra√ß√£o</a>
        </nav>
        
        <main class="content">
            <div class="toggle">
                <button id="btnMacro" class="active" onclick="setView('macro')">üìä Vis√£o Executiva (Macro)</button>
                <button id="btnMicro" onclick="setView('micro')">üìã Vis√£o por Projeto (Micro)</button>
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label>üîç Buscar:</label>
                    <input type="text" id="search" placeholder="Nome do projeto..." oninput="render()">
                </div>
                <div class="filter-group">
                    <label>üìä Status:</label>
                    <select id="filterStatus" onchange="render()">
                        <option value="">Todos</option>
                        <option value="Conclu√≠do">Conclu√≠do</option>
                        <option value="Em andamento">Em andamento</option>
                        <option value="Aguardando">Aguardando</option>
                        <option value="N√£o Iniciado">N√£o Iniciado</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>üìç Local:</label>
                    <select id="filterLocal" onchange="render()"></select>
                </div>
                <div class="filter-group">
                    <label>üë§ Respons√°vel:</label>
                    <select id="filterResp" onchange="render()"></select>
                </div>
            </div>
            
            <div id="macroView" class="phases"></div>
            <div id="microView" class="projects" style="display:none;"></div>
            
            <div class="timestamp" id="ts"></div>
        </main>
    </div>
    
    <div class="modal-bg" id="modal" onclick="fecharModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-head">
                <h2 id="modalTitle">Atividades</h2>
                <button class="modal-close" onclick="fecharModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

<script>
// ===================== DADOS DE TESTE =====================
const PROJETOS = [
    { nome: 'COUGAR', local: 'S√£o Paulo', resp: 'Maria Silva' },
    { nome: 'BETA', local: 'Rio de Janeiro', resp: 'Jo√£o Santos' },
    { nome: 'NAVEPARK', local: 'Curitiba', resp: 'Ana Costa' },
    { nome: 'ESPERAN√áA', local: 'Belo Horizonte', resp: 'Carlos Lima' },
    { nome: 'PBL GUATEMALA', local: 'Guatemala', resp: 'Pedro Souza' },
    { nome: 'CRISTAL MG', local: 'Belo Horizonte', resp: 'Maria Silva' }
];

const FASES = [
    '1. Inicia√ß√£o',
    '2. Planejamento & Documenta√ß√£o', 
    '3. Provisionamento de Recursos',
    '4. Implementa√ß√£o',
    '5. Testes & Homologa√ß√£o',
    '6. Deploy em Produ√ß√£o',
    '7. Estabiliza√ß√£o',
    '8. Encerramento'
];

// Atividades com status variados para testar
const ATIVIDADES = [
    // COUGAR - Fase atual: 4. Implementa√ß√£o (tem Em andamento)
    { proj: 'COUGAR', nome: 'KICKOFF INTERNO', fase: '1. Inicia√ß√£o', status: 'Conclu√≠do' },
    { proj: 'COUGAR', nome: 'Documenta√ß√£o Layout', fase: '2. Planejamento & Documenta√ß√£o', status: 'Conclu√≠do' },
    { proj: 'COUGAR', nome: 'Solicita√ß√£o VPN', fase: '3. Provisionamento de Recursos', status: 'Conclu√≠do' },
    { proj: 'COUGAR', nome: 'Solicita√ß√£o IPs', fase: '3. Provisionamento de Recursos', status: 'Conclu√≠do' },
    { proj: 'COUGAR', nome: 'Instala√ß√£o Equipamentos', fase: '4. Implementa√ß√£o', status: 'Conclu√≠do' },
    { proj: 'COUGAR', nome: 'Configura√ß√£o Rede', fase: '4. Implementa√ß√£o', status: 'Em andamento' },
    { proj: 'COUGAR', nome: 'Testes Homologa√ß√£o', fase: '5. Testes & Homologa√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'COUGAR', nome: 'Deploy Produ√ß√£o', fase: '6. Deploy em Produ√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'COUGAR', nome: 'Monitoramento', fase: '7. Estabiliza√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'COUGAR', nome: 'Aceite Formal', fase: '8. Encerramento', status: 'N√£o Iniciado' },
    
    // BETA - Fase atual: 2. Planejamento (tem Em andamento)
    { proj: 'BETA', nome: 'KICKOFF INTERNO', fase: '1. Inicia√ß√£o', status: 'Conclu√≠do' },
    { proj: 'BETA', nome: 'Documenta√ß√£o Layout', fase: '2. Planejamento & Documenta√ß√£o', status: 'Em andamento' },
    { proj: 'BETA', nome: 'Solicita√ß√£o VPN', fase: '3. Provisionamento de Recursos', status: 'N√£o Iniciado' },
    { proj: 'BETA', nome: 'Instala√ß√£o Equipamentos', fase: '4. Implementa√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'BETA', nome: 'Testes Homologa√ß√£o', fase: '5. Testes & Homologa√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'BETA', nome: 'Deploy Produ√ß√£o', fase: '6. Deploy em Produ√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'BETA', nome: 'Monitoramento', fase: '7. Estabiliza√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'BETA', nome: 'Aceite Formal', fase: '8. Encerramento', status: 'N√£o Iniciado' },
    
    // NAVEPARK - 100% Conclu√≠do - Fase: 8. Encerramento
    { proj: 'NAVEPARK', nome: 'KICKOFF INTERNO', fase: '1. Inicia√ß√£o', status: 'Conclu√≠do' },
    { proj: 'NAVEPARK', nome: 'Documenta√ß√£o Layout', fase: '2. Planejamento & Documenta√ß√£o', status: 'Conclu√≠do' },
    { proj: 'NAVEPARK', nome: 'Solicita√ß√£o VPN', fase: '3. Provisionamento de Recursos', status: 'Conclu√≠do' },
    { proj: 'NAVEPARK', nome: 'Instala√ß√£o Equipamentos', fase: '4. Implementa√ß√£o', status: 'Conclu√≠do' },
    { proj: 'NAVEPARK', nome: 'Testes Homologa√ß√£o', fase: '5. Testes & Homologa√ß√£o', status: 'Conclu√≠do' },
    { proj: 'NAVEPARK', nome: 'Deploy Produ√ß√£o', fase: '6. Deploy em Produ√ß√£o', status: 'Conclu√≠do' },
    { proj: 'NAVEPARK', nome: 'Monitoramento', fase: '7. Estabiliza√ß√£o', status: 'Conclu√≠do' },
    { proj: 'NAVEPARK', nome: 'Aceite Formal', fase: '8. Encerramento', status: 'Conclu√≠do' },
    
    // ESPERAN√áA - Fase atual: 1. Inicia√ß√£o (aguardando)
    { proj: 'ESPERAN√áA', nome: 'KICKOFF INTERNO', fase: '1. Inicia√ß√£o', status: 'Aguardando' },
    { proj: 'ESPERAN√áA', nome: 'Documenta√ß√£o Layout', fase: '2. Planejamento & Documenta√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'ESPERAN√áA', nome: 'Solicita√ß√£o VPN', fase: '3. Provisionamento de Recursos', status: 'N√£o Iniciado' },
    { proj: 'ESPERAN√áA', nome: 'Instala√ß√£o Equipamentos', fase: '4. Implementa√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'ESPERAN√áA', nome: 'Testes Homologa√ß√£o', fase: '5. Testes & Homologa√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'ESPERAN√áA', nome: 'Deploy Produ√ß√£o', fase: '6. Deploy em Produ√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'ESPERAN√áA', nome: 'Monitoramento', fase: '7. Estabiliza√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'ESPERAN√áA', nome: 'Aceite Formal', fase: '8. Encerramento', status: 'N√£o Iniciado' },
    
    // PBL GUATEMALA - N√£o iniciado - Fase: 1. Inicia√ß√£o
    { proj: 'PBL GUATEMALA', nome: 'KICKOFF INTERNO', fase: '1. Inicia√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'PBL GUATEMALA', nome: 'Documenta√ß√£o Layout', fase: '2. Planejamento & Documenta√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'PBL GUATEMALA', nome: 'Solicita√ß√£o VPN', fase: '3. Provisionamento de Recursos', status: 'N√£o Iniciado' },
    { proj: 'PBL GUATEMALA', nome: 'Instala√ß√£o Equipamentos', fase: '4. Implementa√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'PBL GUATEMALA', nome: 'Testes Homologa√ß√£o', fase: '5. Testes & Homologa√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'PBL GUATEMALA', nome: 'Deploy Produ√ß√£o', fase: '6. Deploy em Produ√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'PBL GUATEMALA', nome: 'Monitoramento', fase: '7. Estabiliza√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'PBL GUATEMALA', nome: 'Aceite Formal', fase: '8. Encerramento', status: 'N√£o Iniciado' },
    
    // CRISTAL MG - Fase atual: 5. Testes (tem Em andamento)
    { proj: 'CRISTAL MG', nome: 'KICKOFF INTERNO', fase: '1. Inicia√ß√£o', status: 'Conclu√≠do' },
    { proj: 'CRISTAL MG', nome: 'Documenta√ß√£o Layout', fase: '2. Planejamento & Documenta√ß√£o', status: 'Conclu√≠do' },
    { proj: 'CRISTAL MG', nome: 'Solicita√ß√£o VPN', fase: '3. Provisionamento de Recursos', status: 'Conclu√≠do' },
    { proj: 'CRISTAL MG', nome: 'Solicita√ß√£o IPs', fase: '3. Provisionamento de Recursos', status: 'Conclu√≠do' },
    { proj: 'CRISTAL MG', nome: 'Instala√ß√£o Equipamentos', fase: '4. Implementa√ß√£o', status: 'Conclu√≠do' },
    { proj: 'CRISTAL MG', nome: 'Configura√ß√£o Rede', fase: '4. Implementa√ß√£o', status: 'Conclu√≠do' },
    { proj: 'CRISTAL MG', nome: 'Testes Homologa√ß√£o', fase: '5. Testes & Homologa√ß√£o', status: 'Em andamento' },
    { proj: 'CRISTAL MG', nome: 'Deploy Produ√ß√£o', fase: '6. Deploy em Produ√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'CRISTAL MG', nome: 'Monitoramento', fase: '7. Estabiliza√ß√£o', status: 'N√£o Iniciado' },
    { proj: 'CRISTAL MG', nome: 'Aceite Formal', fase: '8. Encerramento', status: 'N√£o Iniciado' }
];

// ===================== ESTADO =====================
let view = 'macro';
let projetoFiltro = '';

// ===================== FUN√á√ïES DE C√ÅLCULO =====================
function getAtividades(proj) {
    return ATIVIDADES.filter(a => a.proj === proj);
}

function calcProgresso(proj) {
    const ativs = getAtividades(proj);
    if (ativs.length === 0) return 0;
    const done = ativs.filter(a => a.status === 'Conclu√≠do').length;
    return Math.round((done / ativs.length) * 100);
}

function calcStatus(proj) {
    const prog = calcProgresso(proj);
    if (prog === 100) return 'Conclu√≠do';
    if (prog === 0) {
        const ativs = getAtividades(proj);
        if (ativs.some(a => a.status === 'Aguardando')) return 'Aguardando';
        return 'N√£o Iniciado';
    }
    const ativs = getAtividades(proj);
    if (ativs.some(a => a.status === 'Em andamento')) return 'Em andamento';
    if (ativs.some(a => a.status === 'Aguardando')) return 'Aguardando';
    return 'Em andamento';
}

function calcFaseAtual(proj) {
    const ativs = getAtividades(proj);
    if (ativs.length === 0) return FASES[0];
    
    // Se todas conclu√≠das -> Encerramento
    if (ativs.every(a => a.status === 'Conclu√≠do')) return FASES[7];
    
    // Procura fase com "Em andamento" (prioridade 1)
    for (const fase of FASES) {
        const ativsFase = ativs.filter(a => a.fase === fase);
        if (ativsFase.some(a => a.status === 'Em andamento')) return fase;
    }
    
    // Procura fase com "Aguardando" (prioridade 2)
    for (const fase of FASES) {
        const ativsFase = ativs.filter(a => a.fase === fase);
        if (ativsFase.some(a => a.status === 'Aguardando')) return fase;
    }
    
    // Procura primeira fase n√£o totalmente conclu√≠da
    for (const fase of FASES) {
        const ativsFase = ativs.filter(a => a.fase === fase);
        if (ativsFase.length > 0 && !ativsFase.every(a => a.status === 'Conclu√≠do')) {
            return fase;
        }
    }
    
    return FASES[0];
}

function getCor(pct) {
    if (pct >= 100) return 'verde';
    if (pct >= 50) return 'amarelo';
    return 'vermelho';
}

function getStatusClass(s) {
    return s.toLowerCase().replace(/ /g, '-').replace('√£', 'a');
}

// ===================== FILTROS =====================
function getProjetosFiltrados() {
    const search = document.getElementById('search').value.toLowerCase();
    const status = document.getElementById('filterStatus').value;
    const local = document.getElementById('filterLocal').value;
    const resp = document.getElementById('filterResp').value;
    
    return PROJETOS.filter(p => {
        const pStatus = calcStatus(p.nome);
        const matchSearch = !search || p.nome.toLowerCase().includes(search);
        const matchStatus = !status || pStatus === status;
        const matchLocal = !local || p.local === local;
        const matchResp = !resp || p.resp === resp;
        const matchFiltro = !projetoFiltro || p.nome === projetoFiltro;
        return matchSearch && matchStatus && matchLocal && matchResp && matchFiltro;
    });
}

function populateFilters() {
    const locais = [...new Set(PROJETOS.map(p => p.local))].sort();
    const resps = [...new Set(PROJETOS.map(p => p.resp))].sort();
    
    document.getElementById('filterLocal').innerHTML = '<option value="">Todos</option>' + 
        locais.map(l => `<option value="${l}">${l}</option>`).join('');
    document.getElementById('filterResp').innerHTML = '<option value="">Todos</option>' + 
        resps.map(r => `<option value="${r}">${r}</option>`).join('');
}

// ===================== RENDERIZA√á√ÉO =====================
function setView(v) {
    view = v;
    document.getElementById('btnMacro').classList.toggle('active', v === 'macro');
    document.getElementById('btnMicro').classList.toggle('active', v === 'micro');
    document.getElementById('macroView').style.display = v === 'macro' ? 'flex' : 'none';
    document.getElementById('microView').style.display = v === 'micro' ? 'grid' : 'none';
    render();
}

function render() {
    if (view === 'macro') renderMacro();
    else renderMicro();
    updateTimestamp();
}

function renderMacro() {
    const container = document.getElementById('macroView');
    const projetos = getProjetosFiltrados();
    
    // Agrupa por fase atual
    const porFase = {};
    FASES.forEach(f => porFase[f] = []);
    
    projetos.forEach(p => {
        const fase = calcFaseAtual(p.nome);
        porFase[fase].push(p);
    });
    
    let html = '';
    
    FASES.forEach(fase => {
        const projs = porFase[fase];
        if (projs.length === 0) return;
        
        // Calcula % m√©dio da fase
        let totalAtivs = 0, concluidas = 0;
        projs.forEach(p => {
            const ativsFase = getAtividades(p.nome).filter(a => a.fase === fase);
            totalAtivs += ativsFase.length;
            concluidas += ativsFase.filter(a => a.status === 'Conclu√≠do').length;
        });
        const pct = totalAtivs > 0 ? Math.round((concluidas / totalAtivs) * 100) : 0;
        const cor = getCor(pct);
        
        html += `
            <div class="phase-card ${cor}">
                <div class="phase-header">
                    <div>
                        <span class="phase-title">${fase}</span>
                        <span class="phase-count">(${projs.length} projeto${projs.length > 1 ? 's' : ''})</span>
                    </div>
                    <span class="phase-percent ${cor}">${pct}%</span>
                </div>
                <div class="phase-bar"><div class="phase-bar-fill ${cor}" style="width:${pct}%"></div></div>
                <div class="phase-info">${concluidas}/${totalAtivs} atividades conclu√≠das nesta fase</div>
                <div class="phase-projects">
                    <span>Projetos:</span>
                    ${projs.map(p => `<span class="badge" onclick="filtrarProjeto('${p.nome}')">${p.nome}</span>`).join('')}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html || '<div class="empty">Nenhum projeto encontrado</div>';
}

function renderMicro() {
    const container = document.getElementById('microView');
    const projetos = getProjetosFiltrados();
    
    if (projetos.length === 0) {
        container.innerHTML = '<div class="empty">Nenhum projeto encontrado</div>';
        return;
    }
    
    container.innerHTML = projetos.map(p => {
        const prog = calcProgresso(p.nome);
        const status = calcStatus(p.nome);
        const fase = calcFaseAtual(p.nome);
        const cor = getCor(prog);
        
        return `
            <div class="project-card ${cor}" onclick="abrirModal('${p.nome}')">
                <div class="project-name">${p.nome}</div>
                <div class="project-meta">
                    <span>üìç ${p.local}</span>
                    <span>üë§ ${p.resp}</span>
                </div>
                <div class="project-phase">üìò Fase atual: ${fase}</div>
                <div class="progress">
                    <div class="progress-header">
                        <span>Progresso</span>
                        <span style="color:${cor === 'verde' ? '#22c55e' : cor === 'amarelo' ? '#f59e0b' : '#ef4444'}">${prog}%</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill ${cor}" style="width:${prog}%"></div></div>
                </div>
                <span class="status-badge ${getStatusClass(status)}">${status}</span>
            </div>
        `;
    }).join('');
}

// ===================== MODAL =====================
function abrirModal(proj) {
    const ativs = getAtividades(proj);
    const prog = calcProgresso(proj);
    const fase = calcFaseAtual(proj);
    
    const done = ativs.filter(a => a.status === 'Conclu√≠do').length;
    const doing = ativs.filter(a => a.status === 'Em andamento').length;
    const wait = ativs.filter(a => a.status === 'Aguardando').length;
    const notStarted = ativs.filter(a => a.status === 'N√£o Iniciado').length;
    
    document.getElementById('modalTitle').textContent = `üìã ${proj}`;
    
    document.getElementById('modalBody').innerHTML = `
        <div class="summary">
            <div class="summary-item"><div class="num" style="color:#22c55e">${done}</div><div class="lbl">Conclu√≠das</div></div>
            <div class="summary-item"><div class="num" style="color:#3b82f6">${doing}</div><div class="lbl">Em andamento</div></div>
            <div class="summary-item"><div class="num" style="color:#f59e0b">${wait}</div><div class="lbl">Aguardando</div></div>
            <div class="summary-item"><div class="num" style="color:#6b7280">${notStarted}</div><div class="lbl">N√£o iniciadas</div></div>
        </div>
        <p style="margin-bottom:12px;color:#64748b"><strong>Fase atual:</strong> ${fase} | <strong>Progresso:</strong> ${prog}%</p>
        <div class="activity-list">
            ${ativs.map(a => `
                <div class="activity">
                    <div>
                        <div class="activity-name">${a.nome}</div>
                        <div class="activity-fase">${a.fase}</div>
                    </div>
                    <span class="status-badge ${getStatusClass(a.status)}">${a.status}</span>
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('modal').classList.add('show');
}

function fecharModal(e) {
    if (!e || e.target.id === 'modal') {
        document.getElementById('modal').classList.remove('show');
    }
}

// ===================== NAVEGA√á√ÉO =====================
function filtrarProjeto(nome) {
    projetoFiltro = nome;
    document.getElementById('search').value = nome;
    setView('micro');
}

function updateTimestamp() {
    document.getElementById('ts').textContent = 'Atualizado em: ' + new Date().toLocaleString('pt-BR');
}

// ===================== INICIALIZA√á√ÉO =====================
document.addEventListener('keydown', e => { if (e.key === 'Escape') fecharModal(); });

window.addEventListener('DOMContentLoaded', () => {
    // Limpa localStorage antigo para evitar conflitos
    localStorage.removeItem('infraDashboard');
    
    populateFilters();
    render();
});
</script>
</body>
</html>
